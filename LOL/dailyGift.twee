:: GiftSettings [init]
// æ¯æ—¥ç¤¼ç‰©ç³»ç»Ÿé…ç½®
<<set setup.dailyGifts = {
    0: [ // å‘¨æ—¥
        { itemId: "apple", quantity: 5 },
        { itemId: "glass_shard", quantity: 3 },
        { itemId: "gemstone", quantity: 1 }
    ],
    1: [ // å‘¨ä¸€
        { itemId: "coal", quantity: 8 },
        { itemId: "iron_ingot", quantity: 2 },
        { itemId: "pretty_stone", quantity: 4 }
    ],
    2: [ // å‘¨äºŒ
        { itemId: "glass_shard", quantity: 5 },
        { itemId: "gold_nugget", quantity: 1 },
        { itemId: "apple", quantity: 3 }
    ],
    3: [ // å‘¨ä¸‰
        { itemId: "iron_ingot", quantity: 4 },
        { itemId: "gemstone", quantity: 2 },
        { itemId: "coal", quantity: 6 }
    ],
    4: [ // å‘¨å››
        { itemId: "pretty_stone", quantity: 6 },
        { itemId: "gold_nugget", quantity: 2 },
        { itemId: "apple", quantity: 4 }
    ],
    5: [ // å‘¨äº”
        { itemId: "gemstone", quantity: 3 },
        { itemId: "glass_shard", quantity: 8 },
        { itemId: "coal", quantity: 5 }
    ],
    6: [ // å‘¨å…­
        { itemId: "gold_nugget", quantity: 3 },
        { itemId: "iron_ingot", quantity: 3 },
        { itemId: "pretty_stone", quantity: 5 }
    ]
}>>

<<set setup.weekDayNames = ["å‘¨æ—¥", "å‘¨ä¸€", "å‘¨äºŒ", "å‘¨ä¸‰", "å‘¨å››", "å‘¨äº”", "å‘¨å…­"]>>

// åˆå§‹åŒ–ç©å®¶çš„æ¯æ—¥ç¤¼ç‰©è¿½è¸ª
<<set $dailyGiftLastClaimedDate to null>>

:: DailyGiftScript [script]
// æ¯æ—¥ç¤¼ç‰©å®
Macro.add('dailygiftpopup', {
    handler: function() {
        var $button = $("<button id='show-daily-gift'>æ˜Ÿçµçš„ç¤¼ç‰©</button>");
        
        $button.on('click', () => {
            openDailyGiftDialog();
        });
        
        $button.appendTo(this.output);
    }
});

// æ‰“å¼€æ¯æ—¥ç¤¼ç‰©å¼¹çª—çš„å‡½æ•°
window.openDailyGiftDialog = function() {
    var now = new Date();
    var dayOfWeek = now.getDay();
    var today = now.toDateString();
    var weekDayName = setup.weekDayNames[dayOfWeek];
    
    // æ£€æŸ¥ä»Šå¤©æ˜¯å¦å·²ç»é¢†å–
    var alreadyClaimed = State.variables.dailyGiftLastClaimedDate === today;
    
    var dialogHTML = "<div id='daily-gift-content'>" +
        "<div class='daily-gift-info'>" +
            "<p><strong>ä»Šå¤©æ˜¯ï¼š</strong>" + weekDayName + "</p>" +
            "<p><strong>æ—¥æœŸï¼š</strong>" + now.toLocaleDateString('zh-CN') + "</p>" +
        "</div>";
    
    if (alreadyClaimed) {
        dialogHTML += "<div class='gift-status already-claimed'>" +
            "<p>âœ“ ä½ ä»Šå¤©å·²ç»é¢†å–è¿‡ç¤¼ç‰©äº†ï¼</p>" +
            "<p>æ˜å¤©å†æ¥å§~</p>" +
        "</div>";
    } else {
        var giftPool = setup.dailyGifts[dayOfWeek];
        var randomGift = giftPool[Math.floor(Math.random() * giftPool.length)];
        var itemName = setup.Item.get(randomGift.itemId).name;
        
        dialogHTML += "<div class='gift-status unclaimed'>" +
            "<p>ä»Šæ—¥" + weekDayName + "çš„ç¤¼ç‰©ï¼š</p>" +
            "<div class='gift-display'>" +
                "<span class='gift-icon'>ğŸ</span>" +
                "<p class='gift-item'><strong>" + itemName + " x" + randomGift.quantity + "</strong></p>" +
            "</div>" +
            "<button id='claim-daily-gift' data-item='" + randomGift.itemId + "' data-quantity='" + randomGift.quantity + "'>é¢†å–ç¤¼ç‰©</button>" +
        "</div>";
    }
    
    dialogHTML += "<div class='gift-pool-preview'>" +
        "<h4>" + weekDayName + "ç¤¼ç‰©æ± ï¼š</h4>" +
        "<ul>";
    
    setup.dailyGifts[dayOfWeek].forEach(gift => {
        var itemName = setup.Item.get(gift.itemId).name;
        dialogHTML += "<li>" + itemName + " x" + gift.quantity + "</li>";
    });
    
    dialogHTML += "</ul></div></div>";
    
    Dialog.setup("æ˜Ÿçµçš„ç¤¼ç‰©", "daily-gift");
    Dialog.append(dialogHTML);
    
    // ç»‘å®šé¢†å–æŒ‰é’®äº‹ä»¶
    setTimeout(() => {
        $('#claim-daily-gift').on('click', function() {
            var itemId = $(this).data('item');
            var quantity = $(this).data('quantity');
            var itemName = setup.Item.get(itemId).name;
            
            // æ·»åŠ ç‰©å“åˆ°ç©å®¶èƒŒåŒ…
            var inv = State.variables.player;
            inv.pickup(itemId, quantity);
            
            // è®°å½•é¢†å–æ—¥æœŸ
            State.variables.dailyGiftLastClaimedDate = today;
            
            // æ›´æ–°æ˜¾ç¤º
            $('.gift-status').removeClass('unclaimed').addClass('already-claimed');
            $('.gift-status').html(
                "<p>âœ“ æˆåŠŸé¢†å– " + itemName + " x" + quantity + "ï¼</p>" +
                "<p>å·²æ·»åŠ åˆ°ä½ çš„èƒŒåŒ…ä¸­</p>" +
                "<p>æ˜å¤©å†æ¥å§~</p>"
            );
            
            $('#claim-daily-gift').remove();
        });
    }, 0);
    
    Dialog.open();
};
