:: AchievementInit [init]

//æˆå°±å®šä¹‰
<<script>>
// å®šä¹‰æˆå°±
window.defineAchievement(
    'æˆå°±ID20',         // ç¬¬1ä¸ªå‚æ•°ï¼šæˆå°±IDï¼ˆç”¨äºè§¦å‘æˆå°±çš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼‰
    'æˆå°±æ ‡é¢˜',          // ç¬¬2ä¸ªå‚æ•°ï¼šæˆå°±æ ‡é¢˜ï¼ˆæ˜¾ç¤ºç»™ç©å®¶çœ‹çš„åç§°ï¼‰
    'æˆå°±æè¿°', // ç¬¬3ä¸ªå‚æ•°ï¼šæˆå°±æè¿°ï¼ˆè·å¾—æˆå°±åæ˜¾ç¤ºçš„æè¿°ï¼‰
    'ğŸ”‘',               // ç¬¬4ä¸ªå‚æ•°ï¼šæˆå°±å›¾æ ‡ï¼ˆå¯ä»¥ç”¨emojiæˆ–å›¾ç‰‡URLï¼‰ï¼ˆç½‘ç»œå›¾ç‰‡é“¾æ¥ï¼Œæœ¬åœ°å›¾ç‰‡è·¯å¾„ï¼‰
    'test',       // ç¬¬5ä¸ªå‚æ•°ï¼šæˆå°±åˆ†ç±»ï¼ˆç”¨äºåœ¨æˆå°±åˆ—è¡¨ä¸­åˆ†ç±»ï¼‰
    'æœªè§£é”æè¿°' // ç¬¬6ä¸ªå‚æ•°ï¼šæœªè§£é”æè¿°ï¼ˆæˆå°±æœªè·å¾—æ—¶æ˜¾ç¤ºçš„æè¿°ï¼‰
);
<</script>>

<<script>>
// å®šä¹‰æˆå°±
window.defineAchievement(
    'æˆå°±ï¼šæ”¶é›†',         // ç¬¬1ä¸ªå‚æ•°ï¼šæˆå°±IDï¼ˆç”¨äºè§¦å‘æˆå°±çš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼‰
    'æˆå°±ï¼šæ”¶é›†',          // ç¬¬2ä¸ªå‚æ•°ï¼šæˆå°±æ ‡é¢˜ï¼ˆæ˜¾ç¤ºç»™ç©å®¶çœ‹çš„åç§°ï¼‰
    'è¿™æ˜¯ä¸€ä¸ªæ”¶é›†ç±»æˆå°±', // ç¬¬3ä¸ªå‚æ•°ï¼šæˆå°±æè¿°ï¼ˆè·å¾—æˆå°±åæ˜¾ç¤ºçš„æè¿°ï¼‰
    'A',               // ç¬¬4ä¸ªå‚æ•°ï¼šæˆå°±å›¾æ ‡ï¼ˆå¯ä»¥ç”¨emojiæˆ–å›¾ç‰‡URLï¼‰ï¼ˆç½‘ç»œå›¾ç‰‡é“¾æ¥ï¼Œæœ¬åœ°å›¾ç‰‡è·¯å¾„ï¼‰
    'æ”¶é›†å“',       // ç¬¬5ä¸ªå‚æ•°ï¼šæˆå°±åˆ†ç±»ï¼ˆç”¨äºåœ¨æˆå°±åˆ—è¡¨ä¸­åˆ†ç±»ï¼‰
    'ä½ è¿˜æœªè§£é”è¿™ä¸ªæµ‹è¯•ç”¨æ”¶é›†æˆå°±' // ç¬¬6ä¸ªå‚æ•°ï¼šæœªè§£é”æè¿°ï¼ˆæˆå°±æœªè·å¾—æ—¶æ˜¾ç¤ºçš„æè¿°ï¼‰
);
<</script>>

<<script>>
// ç¾é£Ÿå®¶æˆå°±ç³»åˆ—
window.defineAchievement(
    'ç¾é£Ÿå®¶1',
    'ç¾é£Ÿå®¶ I',
    'ä½ å·²ç»å“å°äº†15ç§ç‹¬ç‰¹çš„é£Ÿç‰©ï¼',
    'ğŸ´',
    'ç¾é£Ÿ',
    'å“å°15ç§ç‹¬ç‰¹çš„é£Ÿç‰©'
);

window.defineAchievement(
    'ç¾é£Ÿå®¶2',
    'ç¾é£Ÿå®¶ II',
    'ä½ å·²ç»å“å°äº†30ç§ç‹¬ç‰¹çš„é£Ÿç‰©ï¼çœŸæ˜¯ä¸ªç¾é£Ÿé‰´èµå®¶ï¼',
    'ğŸ½ï¸',
    'ç¾é£Ÿ',
    'å“å°30ç§ç‹¬ç‰¹çš„é£Ÿç‰©'
);

window.defineAchievement(
    'ç¾é£Ÿå®¶3',
    'ç¾é£Ÿå®¶ III',
    'ä½ å·²ç»å“å°äº†45ç§ç‹¬ç‰¹çš„é£Ÿç‰©ï¼ä½ æ˜¯çœŸæ­£çš„ç¾é£Ÿå¤§å¸ˆï¼',
    'ğŸ‘¨â€ğŸ³',
    'ç¾é£Ÿ',
    'å“å°45ç§ç‹¬ç‰¹çš„é£Ÿç‰©'
);
<</script>>


:: AchievementScript [script]

/*æˆå°±ç³»ç»Ÿ*/

if (window.setup === undefined) {
    window.setup = {};
}
window.setup.achievements = [];
window.setup.achievementDefinitions = [];
window.setup.globalAchievements = [];
window.defineAchievement = function(id, title, description, icon, category = "general", lockedDescription = "æœªè§£é”æ—¶çš„æç¤ºæè¿°") {
    let iconContent;
    if (icon.startsWith('http') || icon.startsWith('https')) {
        iconContent = `<img src="${icon}" class="achievement-icon-image" alt="${title}">`;
    } else if (icon.endsWith('.png') || icon.endsWith('.jpg') || icon.endsWith('.jpeg') || icon.endsWith('.gif')) {
        iconContent = `<img src="${icon}" class="achievement-icon-image" alt="${title}">`;
    } else {
        iconContent = icon;
    }
    window.setup.achievementDefinitions.push({
        id: id,
        title: title,
        description: description,
        lockedDescription: lockedDescription,
        icon: iconContent,
        category: category
    });
};
Macro.add('achievement', {
    handler: function() {
        var id = this.args[0];
        var achievement = window.setup.achievementDefinitions.find(a => a.id === id);
        
        if (!achievement) {
            return this.error(`Achievement with ID "${id}" not found`);
        }
        
        State.variables.achievements = State.variables.achievements || [];

        var isUnlockedInCurrentSave = State.variables.achievements.some(a => a.id === id);

        if (!isUnlockedInCurrentSave) {

            const newAchievement = {
                id: id,
                unlockTime: new Date().toISOString()
            };
            
            State.variables.achievements.push(newAchievement);
            window.setup.achievements = State.variables.achievements;
            
            // ç»™äºˆé•€é‡‘ç¥¨åˆ¸
            State.variables.goldTickets = (State.variables.goldTickets || 0) + 1;
            
            // æ±‡æŠ¥é•€é‡‘ç¥¨åˆ¸è·å¾—
            var ticketMsg = $('<div class="ticket-reward"><span class="ticket-icon">ğŸ«</span><p>è·å¾—é•€é‡‘ç¥¨åˆ¸ x1</p></div>');
            ticketMsg.appendTo('body');
            setTimeout(() => ticketMsg.fadeOut(() => ticketMsg.remove()), 2000);

            if (!window.setup.globalAchievements.some(a => a.id === id)) {
                window.setup.globalAchievements.push(newAchievement);
                localStorage.setItem('twine-global-achievements', JSON.stringify(window.setup.globalAchievements));
            }
            
            var $achievement = $("<div class='achievement'>" +
                "<div class='achievement-icon'>" + achievement.icon + "</div>" +
                "<div class='achievement-content'>" +
                    "<div class='achievement-title'>" + achievement.title + "</div>" +
                    "<div class='achievement-description'>" + achievement.description + "</div>" +
                "</div>" +
            "</div>");

            $achievement.appendTo('body');

            requestAnimationFrame(() => {
                $achievement.addClass('show');
            });

            setTimeout(() => {
                $achievement.removeClass('show');
                setTimeout(() => $achievement.remove(), 1000);
            }, 5000);
            
            updateAchievementsList();
        }
    }
});

Macro.add('achievementspopup', {
    handler: function() {
        var categories = [...new Set(window.setup.achievementDefinitions.map(a => a.category))];
        
        var categoryOptions = categories.map(c => `<option value='${c}'>${c}</option>`).join('');
        
        var dialogHTML = "<div id='achievements-fragment'>" +
            "<div class='achievements-filters'>" +
                "<select id='category-filter'>" +
                    "<option value='all'>å…¨éƒ¨åˆ†ç±»</option>" +
                    categoryOptions +
                "</select>" +
                "<select id='status-filter'>" +
                    "<option value='all'>å…¨éƒ¨çŠ¶æ€</option>" +
                    "<option value='unlocked'>å·²è§£é”</option>" +
                    "<option value='locked'>æœªè§£é”</option>" +
                "</select>" +
            "</div>" +
            "<div id='achievements-list'></div>" +
        "</div>";
        
        var $button = $("<button id='show-achievements'>æŸ¥çœ‹æˆå°±</button>");
        
        $button.on('click', () => {
            Dialog.setup("æˆå°±åˆ—è¡¨", "achievements");
            Dialog.append(dialogHTML);
            
            $('#category-filter, #status-filter').on('change', updateAchievementsList);
            
            updateAchievementsList();
            Dialog.open();
        });
        
        $button.appendTo(this.output);
    }
});

Macro.add('checkachievement', {
    handler: function() {
        var id = this.args[0];
        State.variables.hasAchievement = State.variables.achievements && 
                                       State.variables.achievements.some(a => a.id === id);
    }
});

window.checkAchievementCondition = function(id, condition) {
    if (condition && !State.variables.achievements.some(a => a.id === id)) {

        Engine.play(`<<achievement '${id}'>>`);
    }
};

function updateAchievementsList() {
    var $list = $('#achievements-list');
    if (!$list.length) return;

    var categoryFilter = $('#category-filter').val();
    var statusFilter = $('#status-filter').val();

    var scrollTop = $list.scrollTop();

    $list.css('min-height', $list.height());

    $list.empty();

    var fragment = document.createDocumentFragment();
    var itemCount = 0;

    window.setup.achievementDefinitions.forEach(achievement => {
        var isUnlockedInCurrentSave = State.variables.achievements.some(a => a.id === achievement.id);
        var isUnlockedGlobally = window.setup.globalAchievements.some(a => a.id === achievement.id);

        if (categoryFilter !== 'all' && achievement.category !== categoryFilter) return;
        if (statusFilter === 'unlocked' && !isUnlockedGlobally) return;
        if (statusFilter === 'locked' && isUnlockedGlobally) return;

        var title = isUnlockedGlobally ? achievement.title : "???";
        var description = isUnlockedGlobally ? 
            (isUnlockedInCurrentSave ? achievement.description : achievement.description + " (åœ¨å…¶ä»–å­˜æ¡£ä¸­è§£é”)") : 
            (achievement.lockedDescription || "æœªè§£é”çš„æˆå°±");
        var icon = isUnlockedGlobally ? achievement.icon : "â“";
        
        var className = isUnlockedGlobally ? 
            (isUnlockedInCurrentSave ? "unlocked-current" : "unlocked-other") : 
            "locked";

        var $achievementItem = $("<div>").addClass('achievement-item ' + className)
            .attr('data-index', itemCount++) 
            .append(
                $("<span>").addClass('achievement-icon').html(icon),
                $("<div>").addClass('achievement-info')
                    .append(
                        $("<span>").addClass('achievement-title').text(title),
                        $("<div>").addClass('achievement-description').text(description)
                    )
            );

        fragment.appendChild($achievementItem[0]);
    });

    $list.append(fragment);

    $list.scrollTop(scrollTop);

    setTimeout(() => {
        $('.achievement-item').addClass('show');
    }, 50);

    setTimeout(() => {
        $list.css('min-height', '');
    }, 300);

    if ($list.children().length === 0) {
        $list.append("<div class='no-achievements'>æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„æˆå°±</div>");
    }
}

function saveGlobalAchievements() {
    try {
        localStorage.setItem('twine-global-achievements', JSON.stringify(window.setup.globalAchievements));
    } catch (e) {
        console.error('Error saving global achievements:', e);
    }
}

function loadGlobalAchievements() {
    try {
        const savedGlobalAchievements = localStorage.getItem('twine-global-achievements');
        if (savedGlobalAchievements) {
            window.setup.globalAchievements = JSON.parse(savedGlobalAchievements);
        }
    } catch (e) {
        console.error('Error loading global achievements:', e);
        window.setup.globalAchievements = [];
    }
}

$(document).on(':passagestart', function() {
    try {

        loadGlobalAchievements();

        State.variables.achievements = State.variables.achievements || [];
        window.setup.achievements = State.variables.achievements;
    } catch (e) {
        console.error('Error loading achievements:', e);
    }
});

$(document).on(':passagesave', function() {
    try {
        localStorage.setItem('twine-achievements', JSON.stringify(State.variables.achievements));
        saveGlobalAchievements();
    } catch (e) {
        console.error('Error saving achievements:', e);
    }
});

$(document).on(':stateload', function() {
    try {

        loadGlobalAchievements();

        const currentSaveAchievements = State.variables.achievements || [];
        window.setup.achievements = currentSaveAchievements;

        updateAchievementsList();
    } catch (e) {
        console.error('Error loading achievements:', e);
    }
});


:: check [noreturn] {"position":"1425,50","size":"100,100"}
<<checkachievement "æˆå°±ID20">>
<<if $hasAchievement>>
    å·²è·å¾—è¯¥æˆå°±ï¼æ­¤å¤„å¯ä»¥æ›´æ”¹æè¿°ã€‚
<<else>>
	æœªè§£é”
<</if>>
<<checkachievement "æˆå°±ï¼šæ”¶é›†">>
<<if $hasAchievement>>
    å·²è·å¾—è¯¥æˆå°±ï¼æ­¤å¤„å¯ä»¥æ›´æ”¹æè¿°ã€‚
<<else>>
	æœªè§£é”
<</if>>
