:: StoryTitle
LOL


:: StoryData
{
  "ifid": "81274A4A-B097-4ADF-AEE3-D4C9974A546A",
  "format": "SugarCube",
  "format-version": "2.37.3",
  "start": "ç¯ç«",
  "tag-colors": {
    "noreturn": "orange",
    "widget": "blue",
    "nobr": "purple"
  },
  "zoom": 1
}


:: Buy [nobr] {"position":"1100,675","size":"100,100"}
<h2>Items for sale:</h2>
<div class="shopping-interface">
<<for _item, _amount range $shop.table>>
    <<buylink _item _amount>>
<</for>>
</div>
<br><br>
[[Go back|Market]]


:: Inventory {"position":"375,375","size":"100,100"}
<div id="inventory-search">
	<input type="text" id="inv-search-box" placeholder="Search items...">
</div>
<div id="inventory-categories">
	<button class="category-btn active" data-category="all">All</button>
	<button class="category-btn" data-category="ore">Ore</button>
	<button class="category-btn" data-category="crafting">Crafting</button>
	<button class="category-btn" data-category="decoration">Decoration</button>
	<button class="category-btn" data-category="food">Consumable</button>
</div>
<<inv $player>>

<div id="inventory-action-log" style="margin-top: 20px; padding: 15px; background-color: #f5f5f5; border-radius: 8px; border: 1px solid #ddd;">
	<p id="action-log-message" style="margin: 0; color: #555; font-style: italic;">ä½ æ‰“å¼€äº†èƒŒåŒ…ç¿»æ‰¾ç‰©å“</p>
</div>

<<run (function() {
    // è¿½è¸ªè¿ç»­æ¶ˆè€—çš„ç‰©å“
    var lastConsumedItem = null;
    var consumeCount = 0;
    var consumeTimeout = null;
    
    // åˆ†ç±»æŒ‰é’®åŠŸèƒ½
    $(document).off("click", ".category-btn").on("click", ".category-btn", function() {
        var category = $(this).data("category");
        var wrapper = $(".simple-inventory-wrapper");
        var allItems = wrapper.find(".simple-inventory-listing:not(.all-listing)");
        
        // æ›´æ–°æŒ‰é’®æ ·å¼
        $(".category-btn").removeClass("active");
        $(this).addClass("active");
        
        // æ¸…ç©ºæœç´¢æ¡†
        $("#inv-search-box").val("");
        
        if (category === "all") {
            allItems.show();
        } else {
            allItems.each(function() {
                var itemId = $(this).data("item-id").replace(/^-+|-+$/g, "");
                var item_obj = setup.Item.get(itemId);
                if (item_obj && item_obj.hasTag(category)) {
                    $(this).show();
                } else {
                    $(this).hide();
                }
            });
        }
    });
    
    // æœç´¢æ¡†åŠŸèƒ½
    $(document).off("input", "#inv-search-box").on("input", "#inv-search-box", function() {
        var searchText = $(this).val().toLowerCase();
        var wrapper = $(".simple-inventory-wrapper");
        var allItems = wrapper.find(".simple-inventory-listing:not(.all-listing)");
        var activeCategory = $(".category-btn.active").data("category");
        
        if (!searchText) {
            // å¦‚æœæœç´¢æ¡†ä¸ºç©ºï¼ŒæŒ‰åˆ†ç±»æ˜¾ç¤º
            $(".category-btn.active").trigger("click");
            return;
        }
        
        allItems.each(function() {
            var itemName = $(this).data("keyword").toLowerCase();
            var itemId = $(this).data("item-id").replace(/^-+|-+$/g, "");
            var item_obj = setup.Item.get(itemId);
            var matchesSearch = itemName.includes(searchText);
            var matchesCategory = activeCategory === "all" || (item_obj && item_obj.hasTag(activeCategory));
            
            if (matchesSearch && matchesCategory) {
                $(this).show();
            } else {
                $(this).hide();
            }
        });
    });
    
    // æ¶ˆè€—å“ä½¿ç”¨åŠŸèƒ½
    $(document).off("click", ".consume-btn").on("click", ".consume-btn", function() {
        var itemId = $(this).data("item-id").replace(/^-+|-+$/g, "");
        var item_obj = setup.Item.get(itemId);
        
        if (item_obj && item_obj.hasTag("food")) {
            // å¢åŠ ä½“åŠ› - ä½¿ç”¨é…ç½®è¡¨å†³å®šæ¢å¤é‡
            var restoreAmount = (setup.foodEnergy && setup.foodEnergy[itemId]) ? setup.foodEnergy[itemId] : 20;
            new Wikifier(null, "<<addStates \"energy\" " + restoreAmount + ">>");
            // æ¶ˆè€—ç‰©å“ - ä»èƒŒåŒ…å‡å°‘1ä¸ª
            $player.drop(itemId, 1);
            
            // ç‹¬ç‰¹é£Ÿç‰©è¿½è¸ªç³»ç»Ÿ
            var isNewFood = false;
            if (State.variables.uniqueFoodsEaten.indexOf(itemId) === -1) {
                State.variables.uniqueFoodsEaten.push(itemId);
                isNewFood = true;
                
                // æ£€æŸ¥æ˜¯å¦è¾¾åˆ°æ–°çš„é‡Œç¨‹ç¢‘ï¼ˆæ¯5ä¸ªç‹¬ç‰¹é£Ÿç‰©ï¼‰
                var uniqueCount = State.variables.uniqueFoodsEaten.length;
                var newMilestones = Math.floor(uniqueCount / 5);
                
                if (newMilestones > State.variables.foodMilestonesReached) {
                    // å¢åŠ ä½“åŠ›ä¸Šé™
                    var milestoneIncrease = (newMilestones - State.variables.foodMilestonesReached) * 10;
                    State.variables.states.energy.max += milestoneIncrease;
                    State.variables.foodMilestonesReached = newMilestones;
                    
                    // æ˜¾ç¤ºç‰¹æ®Šæ¶ˆæ¯
                    setTimeout(function() {
                        $.wiki("ä½ å“å°äº†è¶³å¤Ÿå¤šçš„ç‹¬ç‰¹é£Ÿç‰©ï¼ä½“åŠ›ä¸Šé™å¢åŠ äº†" + milestoneIncrease + "ç‚¹ï¼(å½“å‰ä¸Šé™: " + State.variables.states.energy.max + ")");
                    }, 100);
                }
                
                // æ£€æŸ¥ç¾é£Ÿå®¶æˆå°±ï¼ˆ15/30/45ç§ç‹¬ç‰¹é£Ÿç‰©ï¼‰
                if (uniqueCount === 15) {
                    setTimeout(function() {
                        new Wikifier(null, "<<achievement 'ç¾é£Ÿå®¶1'>>");
                    }, 200);
                } else if (uniqueCount === 30) {
                    setTimeout(function() {
                        new Wikifier(null, "<<achievement 'ç¾é£Ÿå®¶2'>>");
                    }, 200);
                } else if (uniqueCount === 45) {
                    setTimeout(function() {
                        new Wikifier(null, "<<achievement 'ç¾é£Ÿå®¶3'>>");
                    }, 200);
                }
            }
            
            // æ›´æ–°æ¶ˆæ¯æ—¥å¿—
            var itemName = item_obj.name;
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯è¿ç»­æ¶ˆè€—åŒä¸€ç‰©å“
            if (lastConsumedItem === itemId) {
                consumeCount++;
            } else {
                // ä¸åŒç‰©å“ï¼Œé‡ç½®è®¡æ•°
                lastConsumedItem = itemId;
                consumeCount = 1;
            }
            
            // æ¸…é™¤ä¹‹å‰çš„è¶…æ—¶
            if (consumeTimeout) {
                clearTimeout(consumeTimeout);
            }
            
            // æ˜¾ç¤ºæ¶ˆæ¯
            var message = "ä½ åƒäº†" + itemName + "ï¼Œæ¢å¤äº†" + restoreAmount + "ä½“åŠ›ã€‚";
            if (consumeCount > 1) {
                message += "ï¼ˆx" + consumeCount + "ï¼‰";
            }
            $("#action-log-message").text(message);
            
            // 3ç§’åé‡ç½®ä¸ºé»˜è®¤æ¶ˆæ¯
            consumeTimeout = setTimeout(function() {
                $("#action-log-message").text("ä½ æ‰“å¼€äº†èƒŒåŒ…ç¿»æ‰¾ç‰©å“");
                lastConsumedItem = null;
                consumeCount = 0;
            }, 3000);
            
            // åˆ·æ–°UI
            $(".category-btn.active").trigger("click");
        }
    });
    
    // ä¸ºé£Ÿç‰©ç±»ç‰©å“æ·»åŠ æ¶ˆè€—æŒ‰é’®
    $(document).on(":inventory-update.simple-inventory", function() {
        var wrapper = $(".simple-inventory-wrapper");
        wrapper.find(".simple-inventory-listing:not(.all-listing)").each(function() {
            var itemId = $(this).data("item-id").replace(/^-+|-+$/g, "");
            var item_obj = setup.Item.get(itemId);
            
            // å¦‚æœæ˜¯é£Ÿç‰©ä¸”è¿˜æ²¡æœ‰æ¶ˆè€—æŒ‰é’®ï¼Œæ·»åŠ å®ƒ
            if (item_obj && item_obj.hasTag("food") && !$(this).find(".consume-btn").length) {
                // æ‰¾åˆ°æœ€åä¸€ä¸ªæ“ä½œæŒ‰é’®çš„ä½ç½®ï¼Œåœ¨å…¶åæ’å…¥æ¶ˆè€—æŒ‰é’®
                var lastBtn = $(this).find("a, button").last();
                if (lastBtn.length) {
                    $("<button>")
                        .addClass("consume-btn")
                        .text("Consume")
                        .attr("data-item-id", $(this).data("item-id"))
                        .insertAfter(lastBtn);
                } else {
                    // å¦‚æœæ²¡æœ‰æ‰¾åˆ°æŒ‰é’®ï¼Œç›´æ¥åœ¨åˆ—è¡¨é¡¹çš„æœ€åæ·»åŠ 
                    $("<button>")
                        .addClass("consume-btn")
                        .text("Consume")
                        .attr("data-item-id", $(this).data("item-id"))
                        .appendTo($(this));
                }
            }
        });
    });
    
    // åˆå§‹åŒ–æ—¶è§¦å‘ä¸€æ¬¡äº‹ä»¶æ¥æ·»åŠ æ¶ˆè€—æŒ‰é’®
    setTimeout(function() {
        $(document).trigger(":inventory-update.simple-inventory");
    }, 100);
})()>>


:: Location [nobr] {"position":"1600,675","size":"100,100"}
<<set _locId = $currentLocationId>>
<<set _loc = setup.locations[_locId]>>
<<set _terrain = _loc.terrain>>
<<set _cost = setup.terrainCosts[_terrain] ? setup.terrainCosts[_terrain] : 0>>
<<set _currentEnergy = $states.energy.value>>
<<if _currentEnergy >= _cost>>
    <<set $states.energy.value = _currentEnergy - _cost>>
    <h1><<= _loc.name>></h1>
    <p><em>åœ°å½¢ï¼š<<= _terrain>></em>ï¼ˆæ¶ˆè€—ä½“åŠ› <<= _cost>> ç‚¹ï¼‰</p>
    <p><<= _loc.description>></p>
<<else>>
    <h1><<= _loc.name>></h1>
    <p><em>åœ°å½¢ï¼š<<= _terrain>></em>ï¼ˆæ¶ˆè€—ä½“åŠ› <<= _cost>> ç‚¹ï¼‰</p>
    <p style="color: red;">ä½“åŠ›ä¸è¶³ï¼Œæ— æ³•è¿›å…¥è¯¥åœ°ç‚¹ï¼å‰©ä½™ä½“åŠ› <<= _currentEnergy>>/<<= _cost>>ã€‚</p>
    [[è¿”å›åœ°å›¾|Map]]
    <<stop>>
<</if>>

<<set _locEvents = (_loc.events ? _loc.events : [])>>
<<if not $locationStates[_locId]>>
    <<set _triggered = []>>
    <<set _hasEvent = false>>
    <<for _ev range _locEvents>>
        <<set _eventId = _ev.id>>
        <<set _chance = _ev.chance ? _ev.chance : 100>>
        <<set _roll = random(1,100)>>
        <<if _roll <= _chance>>
            <<set _hasEvent = true>>
            <<set _triggered.push(_eventId)>>
        <</if>>
    <</for>>
    <<set $locationStates[_locId] = { hasEvent: _hasEvent, triggeredEvents: _triggered }>>
<</if>>

<<set _locState = $locationStates[_locId]>>

<<if _locState.hasEvent>>
    <<for _eventId range _locState.triggeredEvents>>
        <<set $currentEventPassage = setup.events[_eventId].passage>>
        <p>ä½ é‡åˆ°äº†äº‹ä»¶ï¼š<<= setup.events[_eventId].name>></p>
        <<include $currentEventPassage>>
    <</for>>
<<else>>
    <p>è¿™é‡Œæš‚æ—¶æ²¡æœ‰å¯ä»¥å‘ç”Ÿçš„äº‹ä»¶ã€‚</p>
<</if>>

<<link "è¿”å›åœ°å›¾">>
    <<run delete $locationStates[$currentLocationId]>>
    <<run delete $eventFlags.apple_tree_ripe>>
    <<goto "Map">>
<</link>>


:: Map [nobr] {"position":"1450,675","size":"100,100"}
<h1>åœ°å›¾</h1>
<p>é€‰æ‹©ä¸€ä¸ªåœ°ç‚¹è¿›è¡Œæ¢ç´¢ï¼š</p>
<div class="location-list">
<<for _locId, _locData range setup.locations>>
    <div class="location-item">
        <h3><<= _locData.name>></h3>
        <p><<= _locData.description>></p>
        <<capture _locId>>
            <<link "è¿›å…¥">>
                <<set $currentLocationId = _locId>>
                <<goto "Location">>
            <</link>>
        <</capture>>
    </div>
<</for>>
</div>
[[Go back|Start]]


:: Market {"position":"1350,425","size":"100,100"}
ä½ æŠµè¾¾äº†æ£®æ—å¸‚åœºã€‚

[[Buy Items|Buy]]
[[Sell Items|Sell]]
[[Go home|Start]]
[[è¿”å›æ£®æ—|Location]]


<<button "exp + 20">>
<<xp 20>>
<</button>>


:: PlayerStats {"position":"500,200","size":"100,100"}



:: Sell [nobr] {"position":"1200,675","size":"100,100"}
<h2>Items on hand:</h2>
<div class="shopping-interface">
<<for _item, _amount range $player.table>>
    <<selllink _item _amount>>
<</for>>
</div>
<br><br>
[[Go back|Market]]


:: Start {"position":"1325,675","size":"100,100"}
You are at your house.

Next to you is your storage locker!

[[Open storage locker|Storage]]
[[Go to the market|Market]]
[[Go to the map|Map]]


:: Storage {"position":"1325,825","size":"100,100"}
<h2>On hand:</h2>\
<<give $player $storage stack all>>
<h2>In storage:</h2>\
<<take $storage $player stack all>>

[[Go back|Start]]


:: StoryCaption {"position":"750,50","size":"100,100"}
<<for _key, _state range $states>>
  <font color="gold">_state.nameï¼š</font>
  <<showProgress _key>>
<</for>>
<hr style="border: none; border-top: 1px solid white; margin: 1px;"><<timeWidget>> - $showHour : $formattedMinute<br><hr style="border: none; border-top: 1px solid white; margin: 0;">
é‡‘é’±ï¼š$Money <br>
åå£°ï¼š$MissionStats.Fame | æ´»è·ƒå§”æ‰˜ï¼š<<= $ActiveMissions.length >>/$MaxActiveMissions<br>
ç­‰çº§: @@#level;<<= $level>>@@ (XP: @@#xp;<<= $xp>>@@ / è·ç¦»ä¸‹ä¸€çº§: @@#xp-to-next;<<= $xpToNext>>@@)


:: StoryInit {"position":"625,50","size":"100,100"}
//ä¸»è§’
<<set $player={
name:"å¬å”¤å¸ˆ",
sanValue: 100,
}>>
<<set $level to 1>>
<<set $xp to 0>>
<<set $xpToNext to 50>>
<<set $states = {
    energy: { name: "ä½“åŠ›", value: 50, max: 100 },

}>>

//ç‹¬ç‰¹é£Ÿç‰©è¿½è¸ªç³»ç»Ÿ
<<set $uniqueFoodsEaten to []>>  /*å·²åƒè¿‡çš„ç‹¬ç‰¹é£Ÿç‰©åˆ—è¡¨*/
<<set $foodMilestonesReached to 0>>  /*å·²è¾¾åˆ°çš„é‡Œç¨‹ç¢‘æ¬¡æ•°ï¼ˆæ¯5ä¸ªç‹¬ç‰¹é£Ÿç‰©ï¼‰*/

    /*è¿™é‡Œä¿®æ”¹é¢œè‰²æ¡£ä½å’Œæ•°å€¼ï¼Œè¦ç¡®ä¿è¿™ä¸¤ä¸ªä¸€è‡´*/
<<set $rangesProgress=[20,40,60,80,90,100]>>
<<set $colorProgress=["#92d618", "#19AAD1", "#d1bdff", "#FFCC4C", "#FF6090", "#EF303B"]>>
/*<<run console.log($colorProgress)>>*/	


//æµ‹è¯•è§’è‰²ä¸é˜Ÿä¼
<<set $teamList to ["å‘æ—¥è‘µ"]>>

<<set $testCharA = {name : "å‘æ—¥è‘µ",tie : 3,juqing : ["æµ‹è¯•å‰§æƒ…1", "æµ‹è¯•å‰§æƒ…2"]}>>


//æµ‹è¯•èƒŒåŒ…ï¼Œåº“å­˜ä¸å•†åº—
//æ–°å»ºç©å®¶ï¼Œå•†åº—å’Œåº“å­˜çš„inventory
<<newinv $player>>
<<newinv $shop>>
<<newinv $storage>>

<<set $Money to 100>>
//æ–°å»ºç‰©å“
<<item "coal" "Coal">><<tags "ore">><</item>>
<<item "iron_ingot" "Iron Ingot">><<tags "ore">><</item>>
<<item "glass_shard" "Glass Shard">><<tags "crafting">><</item>>
<<item "gold_nugget" "Gold Nugget">><<tags "ore">><</item>>
<<item "pretty_stone" "Pretty Stone">><<tags "decoration">><</item>>
<<item "gemstone" "Gemstone">><<tags "crafting">><</item>>
<<consumable "apple" "è‹¹æœ">><<tags "food">><</consumable>>
<<consumable "wild_berry" "é‡è“">><<tags "food">><</consumable>>
<<consumable "berry_choc" "è“æœå·§å…‹åŠ›">><<tags "food">><</consumable>>
<<consumable "banana_choc" "é¦™è•‰å·§å…‹åŠ›">><<tags "food">><</consumable>>
<<consumable "apple_choc" "è‹¹æœå·§å…‹åŠ›">><<tags "food">><</consumable>>
<<consumable "fruit_salad" "æ°´æœæ²™æ‹‰">><<tags "food">><</consumable>>
<<consumable "roast_chicken" "çƒ¤é¸¡">><<tags "food">><</consumable>>
<<consumable "meat_stew" "è‚‰ç±»ç‚–èœ">><<tags "food">><</consumable>>
<<consumable "mixed_vegetable_soup" "æ‚çƒ©è”¬èœæ±¤">><<tags "food">><</consumable>>
<<consumable "energy_drink_lemon" "æŸ æª¬å‘³èƒ½é‡é¥®">><<tags "food">><</consumable>>
<<consumable "fried_skewers_chicken_wings" "é¸¡ç¿…ç‚¸ä¸²">><<tags "food">><</consumable>>

// é£Ÿç‰©ä½“åŠ›æ¢å¤è¡¨
<<set setup.foodEnergy = {
    apple: 12,
    wild_berry: 8,
    berry_choc: 14,
    banana_choc: 14,
    apple_choc: 12,
    fruit_salad: 16,
    roast_chicken: 35,
    meat_stew: 30,
    mixed_vegetable_soup: 22,
    energy_drink_lemon: 18,
    fried_skewers_chicken_wings: 25
}>>


//è®¾ç½®ç‰©å“ä»·æ ¼ï¼š
<<set setup.prices = new Map([
    ["gemstone", 35],
    ["coal", 2],
    ["iron_ingot", 12],
    ["glass_shard", 5],
    ["gold_nugget", 50],
    ["pretty_stone", 3],
    ["apple", 5],
    ["wild_berry", 4],
    ["berry_choc", 10],
    ["banana_choc", 10],
    ["apple_choc", 8],
    ["fruit_salad", 15],
    ["roast_chicken", 25],
    ["meat_stew", 30],
    ["mixed_vegetable_soup", 20],
    ["energy_drink_lemon", 12],
    ["fried_skewers_chicken_wings", 18]
])>>
//ç»™ä¸å¯¹åº”inventory ç‰©å“
<<set $currentCategory to "all">>
<<pickup $shop "coal" 10 "gold_nugget" 2 "iron_ingot" 5>>
<<pickup $storage "iron_ingot" 1 "glass_shard" 20>>
<<pickup $player "glass_shard" 10 "pretty_stone" 20 "gemstone" 5 "apple" 10 "wild_berry" 5 "berry_choc" 2>>

//===== ä»»åŠ¡ç³»ç»Ÿåˆå§‹åŒ– =====
/* æ—¶é—´ */
<<set $minute = 0>>
<<set $hour = 8>>
<<set $day = 1>>
<<set $weekDay = 1>>
<<set $month = 1>>
<<set $year = 1>>
<<set $showMinute = 0>>
<<set $showHour = 8>>
<<set $formattedMinute = 0>>

//å¤šä»»åŠ¡ç³»ç»Ÿæ•°æ®ç»“æ„
<<set $MissionStats to {
  "Success": 0,     /*æˆåŠŸæ¬¡æ•°*/
  "Total": 0,       /*æ€»ä»»åŠ¡æ•°*/
  "Failure": 0,     /*å¤±è´¥æ¬¡æ•°*/
  "Fame": 0         /*åå£°å€¼*/
}>>

//æ´»è·ƒå§”æ‰˜ä»»åŠ¡é˜Ÿåˆ—
<<set $ActiveMissions = []>>

//å§”æ‰˜ä»»åŠ¡é¢„è§ˆ
<<set $MissionPreview = "">>

//å§”æ‰˜ä»»åŠ¡é¢„è§ˆæ•°æ®ï¼ˆç”¨äºä¿å­˜åŠ¨æ€ç”Ÿæˆçš„ä»»åŠ¡æ•°æ®ï¼‰
<<set $MissionPreviewData = {}>>

//æœ€å¤§å¯åŒæ—¶è¿›è¡Œçš„å§”æ‰˜ä»»åŠ¡æ•°
<<set $MaxActiveMissions = 3>>

//ä¸»çº¿ä»»åŠ¡ç³»ç»Ÿ
<<set $MainMission = {
  "id": "main_1",           /*ä¸»çº¿ä»»åŠ¡ID*/
  "name": "ç¬¬ä¸€ç« ï¼šèµ·èˆª",   /*ä¸»çº¿ä»»åŠ¡åç§°*/
  "currentStage": 0,        /*å½“å‰é˜¶æ®µç´¢å¼•*/
  "complete": false,        /*æ˜¯å¦å®Œæˆ*/
  "stages": [
    { id: "1-1", name: "ä¸NPCå¯¹è¯", complete: false, description: "æ‰¾åˆ°æ‘é•¿äº†è§£æƒ…å†µ" },
    { id: "1-2", name: "æ”¶é›†çº¿ç´¢", complete: false, description: "æ”¶é›†ä¸‰ä¸ªçº¿ç´¢ç‰©å“" },
    { id: "1-3", name: "åšå‡ºå†³å®š", complete: false, description: "æ ¹æ®çº¿ç´¢åšå‡ºé€‰æ‹©" }
  ]
}>>

<<set $MissionSet1 to ["K", "L"]>>
<<set $MissionSet2 to ["K", "L"]>>
<<set $MissionSet3 to ["K", "L"]>>
<<set $MissionToday to ["K", "L"]>>

//ä»»åŠ¡å¥–åŠ±é…ç½®ï¼ˆæ”¶é›†ä»»åŠ¡ä½¿ç”¨åŠ¨æ€å¥–åŠ±ï¼Œä¸éœ€è¦åœ¨æ­¤é…ç½®ï¼‰
<<set setup.missionRewards = {}>>

//ä»»åŠ¡é…ç½®ï¼ˆæ˜¾ç¤ºåç§°å’Œç±»å‹ï¼‰
<<set setup.missionConfig = {
    K: { name: "æ”¶é›†è‹¹æœ", type: "collect", itemId: "apple", itemName: "è‹¹æœ" },
    L: { name: "æ”¶é›†é‡è“", type: "collect", itemId: "wild_berry", itemName: "é‡è“" }
}>>

//æ”¶é›†ç±»ä»»åŠ¡é…ç½®ï¼ˆå¯æ‰©å±•ï¼‰
<<set setup.collectMissions = {
    K: { itemId: "apple", itemName: "è‹¹æœ", minCount: 2, maxCount: 5, rewardPerItem: 7 },
    L: { itemId: "wild_berry", itemName: "é‡è“", minCount: 5, maxCount: 7, rewardPerItem: 6 }
}>>

// åœ°ç‚¹ä¸äº‹ä»¶é…ç½®ï¼ˆæ”¯æŒå¤šäº‹ä»¶ç‹¬ç«‹æ¦‚ç‡ï¼‰
<<set setup.locations = {
    small_forest: {
        id: "small_forest",
        name: "å°æ£®æ—",
        terrain: "forest",
        description: "ä¸€ä¸ªå……æ»¡ç”Ÿæœºçš„å°æ£®æ—ï¼Œç»¿æ ‘æˆè«ã€‚",
        collectibles: [ { itemId: "apple", min: 1, max: 3, chance: 80 } ],
        events: [
            { id: "apple_tree_ripe", chance: 80 },
            { id: "forest_merchant", chance: 30 }
        ]
    },
    valley: {
        id: "valley",
        name: "æºªè°·",
        terrain: "river",
        description: "æºªæµç¯ç»•çš„å±±è°·ã€‚",
        events: [ { id: "wild_berries", chance: 80 } ],
        collectibles: [ { itemId: "berry", min: 1, max: 4, chance: 70 } ]
    }
}>>

<<set setup.events = {
    apple_tree_ripe: {
        id: "apple_tree_ripe",
        name: "è‹¹æœæ ‘æˆç†Ÿ",
        weight: 100,
        passage: "äº‹ä»¶ï¼šè‹¹æœæ ‘æˆç†Ÿ"
    },
    forest_merchant: {
        id: "forest_merchant",
        name: "æ£®æ—å•†äºº",
        weight: 30,
        passage: "äº‹ä»¶ï¼šæ£®æ—å•†äºº"
    },
    wild_berries: {
        id: "wild_berries",
        name: "é‡è“ä¸›",
        weight: 80,
        passage: "äº‹ä»¶ï¼šé‡è“ä¸›"
    }
}>>

// åœ°å½¢æ¶ˆè€—æ˜ å°„
<<set setup.terrainCosts = {
    forest: 5,
    river: 8,
    mountain: 10
}>>

// å½“å‰åœ°ç‚¹ä¸äº‹ä»¶å˜é‡
<<set $currentLocationId to null>>
<<set $currentEventId to null>>
<<set $currentEventPassage to null>>
<<set $eventFlags to {}>>
<<set $locationStates to {}>>

// æ¯æ—¥ç¤¼ç‰©ç³»ç»Ÿé…ç½®
<<set setup.dailyGifts = {
    0: [ // å‘¨æ—¥
        { itemId: "apple", quantity: 5 },
        { itemId: "glass_shard", quantity: 3 },
        { itemId: "gemstone", quantity: 1 }
    ],
    1: [ // å‘¨ä¸€
        { itemId: "coal", quantity: 8 },
        { itemId: "iron_ingot", quantity: 2 },
        { itemId: "pretty_stone", quantity: 4 }
    ],
    2: [ // å‘¨äºŒ
        { itemId: "glass_shard", quantity: 5 },
        { itemId: "gold_nugget", quantity: 1 },
        { itemId: "apple", quantity: 3 }
    ],
    3: [ // å‘¨ä¸‰
        { itemId: "iron_ingot", quantity: 4 },
        { itemId: "gemstone", quantity: 2 },
        { itemId: "coal", quantity: 6 }
    ],
    4: [ // å‘¨å››
        { itemId: "pretty_stone", quantity: 6 },
        { itemId: "gold_nugget", quantity: 2 },
        { itemId: "apple", quantity: 4 }
    ],
    5: [ // å‘¨äº”
        { itemId: "gemstone", quantity: 3 },
        { itemId: "glass_shard", quantity: 8 },
        { itemId: "coal", quantity: 5 }
    ],
    6: [ // å‘¨å…­
        { itemId: "gold_nugget", quantity: 3 },
        { itemId: "iron_ingot", quantity: 3 },
        { itemId: "pretty_stone", quantity: 5 }
    ]
}>>

<<set setup.weekDayNames = ["å‘¨æ—¥", "å‘¨ä¸€", "å‘¨äºŒ", "å‘¨ä¸‰", "å‘¨å››", "å‘¨äº”", "å‘¨å…­"]>>

// åˆå§‹åŒ–ç©å®¶çš„æ¯æ—¥ç¤¼ç‰©è¿½è¸ª
<<set $dailyGiftLastClaimedDate to null>>

// é•€é‡‘ç¥¨åˆ¸ç³»ç»Ÿ
<<set $goldTickets to 0>>

// æŠ½å¥–å¥–å“æ±  (æŒ‚ä¸¢ç‰©å“åç§°ï¼Œä½ ä¹‹å¾Œå¯æ”¹ä¸ºitemIdï¼‰
<<set setup.lotteryPrizes = [
    { itemId: "coal", quantity: 3, probability: 20 },
    { itemId: "iron_ingot", quantity: 2, probability: 20 },
    { itemId: "glass_shard", quantity: 5, probability: 20 },
    { itemId: "gold_nugget", quantity: 1, probability: 18 },
    { itemId: "pretty_stone", quantity: 4, probability: 12 },
    { itemId: "gemstone", quantity: 1, probability: 10 }
]>>

// é•€é‡‘ç¥¨åˆ¸ç³»ç»Ÿ
<<set $goldTickets to 0>>

// æŠ½å¥–å¥–å“æ± 
<<set setup.lotteryPrizes = [
    { itemId: "coal", quantity: 3, probability: 20 },
    { itemId: "iron_ingot", quantity: 2, probability: 20 },
    { itemId: "glass_shard", quantity: 5, probability: 20 },
    { itemId: "gold_nugget", quantity: 1, probability: 18 },
    { itemId: "pretty_stone", quantity: 4, probability: 12 },
    { itemId: "gemstone", quantity: 1, probability: 10 }
]>>

// åˆå§‹åŒ–ç©å®¶çš„æ¯æ—¥ç¤¼ç‰©è¿½è¸ª
<<set $dailyGiftLastClaimedDate to null>>


//æˆå°±
<<script>>
// å®šä¹‰æˆå°±
window.defineAchievement(
    'æˆå°±ID20',         // ç¬¬1ä¸ªå‚æ•°ï¼šæˆå°±IDï¼ˆç”¨äºè§¦å‘æˆå°±çš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼‰
    'æˆå°±æ ‡é¢˜',          // ç¬¬2ä¸ªå‚æ•°ï¼šæˆå°±æ ‡é¢˜ï¼ˆæ˜¾ç¤ºç»™ç©å®¶çœ‹çš„åç§°ï¼‰
    'æˆå°±æè¿°', // ç¬¬3ä¸ªå‚æ•°ï¼šæˆå°±æè¿°ï¼ˆè·å¾—æˆå°±åæ˜¾ç¤ºçš„æè¿°ï¼‰
    'ğŸ”‘',               // ç¬¬4ä¸ªå‚æ•°ï¼šæˆå°±å›¾æ ‡ï¼ˆå¯ä»¥ç”¨emojiæˆ–å›¾ç‰‡URLï¼‰ï¼ˆç½‘ç»œå›¾ç‰‡é“¾æ¥ï¼Œæœ¬åœ°å›¾ç‰‡è·¯å¾„ï¼‰
    'test',       // ç¬¬5ä¸ªå‚æ•°ï¼šæˆå°±åˆ†ç±»ï¼ˆç”¨äºåœ¨æˆå°±åˆ—è¡¨ä¸­åˆ†ç±»ï¼‰
    'æœªè§£é”æè¿°' // ç¬¬6ä¸ªå‚æ•°ï¼šæœªè§£é”æè¿°ï¼ˆæˆå°±æœªè·å¾—æ—¶æ˜¾ç¤ºçš„æè¿°ï¼‰
);
<</script>>

<<script>>
// å®šä¹‰æˆå°±
window.defineAchievement(
    'æˆå°±ï¼šæ”¶é›†',         // ç¬¬1ä¸ªå‚æ•°ï¼šæˆå°±IDï¼ˆç”¨äºè§¦å‘æˆå°±çš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼‰
    'æˆå°±ï¼šæ”¶é›†',          // ç¬¬2ä¸ªå‚æ•°ï¼šæˆå°±æ ‡é¢˜ï¼ˆæ˜¾ç¤ºç»™ç©å®¶çœ‹çš„åç§°ï¼‰
    'è¿™æ˜¯ä¸€ä¸ªæ”¶é›†ç±»æˆå°±', // ç¬¬3ä¸ªå‚æ•°ï¼šæˆå°±æè¿°ï¼ˆè·å¾—æˆå°±åæ˜¾ç¤ºçš„æè¿°ï¼‰
    'A',               // ç¬¬4ä¸ªå‚æ•°ï¼šæˆå°±å›¾æ ‡ï¼ˆå¯ä»¥ç”¨emojiæˆ–å›¾ç‰‡URLï¼‰ï¼ˆç½‘ç»œå›¾ç‰‡é“¾æ¥ï¼Œæœ¬åœ°å›¾ç‰‡è·¯å¾„ï¼‰
    'æ”¶é›†å“',       // ç¬¬5ä¸ªå‚æ•°ï¼šæˆå°±åˆ†ç±»ï¼ˆç”¨äºåœ¨æˆå°±åˆ—è¡¨ä¸­åˆ†ç±»ï¼‰
    'ä½ è¿˜æœªè§£é”è¿™ä¸ªæµ‹è¯•ç”¨æ”¶é›†æˆå°±' // ç¬¬6ä¸ªå‚æ•°ï¼šæœªè§£é”æè¿°ï¼ˆæˆå°±æœªè·å¾—æ—¶æ˜¾ç¤ºçš„æè¿°ï¼‰
);
<</script>>

<<script>>
// ç¾é£Ÿå®¶æˆå°±ç³»åˆ—
window.defineAchievement(
    'ç¾é£Ÿå®¶1',
    'ç¾é£Ÿå®¶ I',
    'ä½ å·²ç»å“å°äº†15ç§ç‹¬ç‰¹çš„é£Ÿç‰©ï¼',
    'ğŸ´',
    'ç¾é£Ÿ',
    'å“å°15ç§ç‹¬ç‰¹çš„é£Ÿç‰©'
);

window.defineAchievement(
    'ç¾é£Ÿå®¶2',
    'ç¾é£Ÿå®¶ II',
    'ä½ å·²ç»å“å°äº†30ç§ç‹¬ç‰¹çš„é£Ÿç‰©ï¼çœŸæ˜¯ä¸ªç¾é£Ÿé‰´èµå®¶ï¼',
    'ğŸ½ï¸',
    'ç¾é£Ÿ',
    'å“å°30ç§ç‹¬ç‰¹çš„é£Ÿç‰©'
);

window.defineAchievement(
    'ç¾é£Ÿå®¶3',
    'ç¾é£Ÿå®¶ III',
    'ä½ å·²ç»å“å°äº†45ç§ç‹¬ç‰¹çš„é£Ÿç‰©ï¼ä½ æ˜¯çœŸæ­£çš„ç¾é£Ÿå¤§å¸ˆï¼',
    'ğŸ‘¨â€ğŸ³',
    'ç¾é£Ÿ',
    'å“å°45ç§ç‹¬ç‰¹çš„é£Ÿç‰©'
);
<</script>>


:: StoryMenu {"position":"1225,50","size":"100,100"}
<<link"æ˜Ÿçµçš„ç¤¼ç‰©">>
  <<run openDailyGiftDialog()>>
<</link>>

<<link"æ£€æŸ¥æˆå°±çŠ¶æ€">>
  <<script>>
    Dialog.create("æ£€æŸ¥æˆå°±çŠ¶æ€");
    Dialog.wikiPassage("check");
    Dialog.open();
  <</script>>
<</link>>
<<link "èƒŒåŒ…">>
    <<run Dialog.setup("Inventory", "inventory"); Dialog.wiki(Story.get("Inventory").text); Dialog.open()>>
<</link>>

<<link "å¬å”¤ä¹‹ä¹¦">>
	<<run multiplePopUpTab("page1", "1")>> //å¤šé¡µé¢å¼¹çª—æµ‹è¯•ï¼Œéœ€è¦ä¿®æ”¹å¾—è¿›js
<</link>>


:: addStates [widget nobr] {"position":"1050,50","size":"100,100"}
<<widget "addStates">>
    /*_args[0]è¡¨ç¤ºè¦å¢åŠ çš„æ•°å€¼ç±»å‹ï¼Œåªèƒ½æ˜¯statusä¸­çš„å±æ€§*/
    /*_args[1]è¡¨ç¤ºè¦å¢åŠ çš„æ•°å€¼*/

//è¿™é‡Œä¿®æ”¹æ•°å€¼ï¼›
    <<set _states=$states[_args[0]]>>
    

    <<set _states.value+=_args[1]>>

//è¿™é‡Œåˆ¤æ–­ä¸´ç•Œå€¼ï¼›
    <<if _states.value <0 >>
        <<set _states.value=0>>
    <</if>>
    <<if _states.value > _states.max >>
        <<set _states.value=_states.max>>
    <</if>>
    
    /*æŒ‡å®šé¢œè‰²å’Œwidth*/
    <<set _width=(100*_states.value/_states.max)+"%">>
    /*<<run console.log(_width)>>*/
    

    
    <<set _width1=(100*_states.value/_states.max)>>
    /*<<run console.log(_width1)>>*/

/*è¿™é‡Œåˆ¤æ–­å¤„äºé‚£ä¸ªåŒºé—´*/
    <<for _i, _name range $rangesProgress>>
    <<if _width1<=_name>>
        <<set _color= $colorProgress[_i]>>
        <<break>>
    <</if>>
    <</for>>
    
    /*<<run console.log(_color)>>*/

/*ä¿®æ”¹è¿›åº¦æ¡å±æ€§*/
    <<run $('#'+_args[0]+'').css({
        'width': ''+_width+'',
        'background-color': ''+_color+''
    })>>

    <</widget>>


:: check [noreturn] {"position":"1425,50","size":"100,100"}
<<checkachievement "æˆå°±ID20">>
<<if $hasAchievement>>
    å·²è·å¾—è¯¥æˆå°±ï¼æ­¤å¤„å¯ä»¥æ›´æ”¹æè¿°ã€‚
<<else>>
	æœªè§£é”
<</if>>
<<checkachievement "æˆå°±ï¼šæ”¶é›†">>
<<if $hasAchievement>>
    å·²è·å¾—è¯¥æˆå°±ï¼æ­¤å¤„å¯ä»¥æ›´æ”¹æè¿°ã€‚
<<else>>
	æœªè§£é”
<</if>>


:: inventoryWidgets [widget nobr] {"position":"950,150","size":"100,100"}
<<widget "Money">>
    <<set $Money to Math.clamp($Money + _args[0], 0, Infinity)>>
    <<replace "#Money">><<= $Money>><</replace>>
<</widget>>

<<widget "buylink">>
    <<set _item to _args[0]>>
    <<set _amount to _args[1]>>
    <<set _price to setup.prices.get(_item) || 1>>
    <p @data-item="_item" class="buy-listing shop-listing">
        <span class="item-name"><<= (setup.Item.has(_item) ? setup.Item.get(_item).name : _item) >></span>
        <span class="price">ä»·æ ¼ï¼š<strong><<= _price >></strong></span>
        <span class="count"><<= _amount >></span>
        <span class="actions">
            <<capture _item, _amount, _price>>
                <<link "è´­ä¹°">>
                    <<if $Money < _price>>
                        <<run UI.alert("ä½ çš„é‡‘å¸ä¸è¶³ï¼")>>
                    <<else>>
                        <<Money `-1 * _price`>>
                        <<transfer $shop $player _item 1>>
                        <<set _amount -->>
                        <<if _amount > 0>>
                            <<replace `"p.buy-listing[data-item=\"" + _item + "\"] > .count"`>><<= _amount >><</replace>>
                        <<else>>
                            <<remove `"p.buy-listing[data-item=\"" + _item + "\"]"`>>
                        <</if>>
                    <</if>>
                <</link>>
            <</capture>>
        </span>
    </p>
<</widget>>

<<widget "selllink">>
    <<set _item to _args[0]>>
    <<set _amount to _args[1]>>
    <<set _price to setup.prices.get(_item) || 1>>
    <p @data-item="_item" class="sell-listing shop-listing">
        <span class="item-name"><<= (setup.Item.has(_item) ? setup.Item.get(_item).name : _item) >></span>
        <span class="price">å”®ä»·ï¼š<strong><<= _price >></strong></span>
        <span class="count"><<= _amount >></span>
        <span class="actions">
            <<capture _item, _amount, _price>>
                <<link "å–å‡º">>
                    <<Money _price>>
                    <<transfer $player $shop _item 1>>
                    <<set _amount -->>
                    <<if _amount > 0>>
                        <<replace `"p.sell-listing[data-item=\"" + _item + "\"] > .count"`>><<= _amount >><</replace>>
                    <<else>>
                        <<remove `"p.sell-listing[data-item=\"" + _item + "\"]"`>>
                    <</if>>
                <</link>>
            <</capture>>
        </span>
    </p>
<</widget>>


:: showProgress [widget nobr] {"position":"950,50","size":"100,100"}
<<widget "showProgress">><<nobr>>
    <<set _states=$states[_args[0]]>>
    
    <<set _width1=(100*_states.value/_states.max)>>
    
    <<for _i, _name range $rangesProgress>>
    <<capture _i>>
    <<if _width1<=_name>>
        <<set _color= $colorProgress[_i]>>
        <<break>>
    <</if>>
    <</capture>>
    <</for>>
    
    <<set _style="background-color:"+_color+";width:"+_width1+"%">>
    <div @id="'bar-'+_args[0]" class="state-bar" @data-state-id="_args[0]">
        <div @id="_args[0]" class="state-progress" @style="_style"></div>
        <div class="state-tooltip"></div>
    </div>
    
    <<run setup.updateTooltip(_args[0])>>
<</nobr>>
<</widget>>


:: xpWidgets [widget] {"position":"1050,150","size":"100,100"}
<<widget "xp">>
    <<set _gain to Number(_args[0] || 0)>>
    <<run (function(){
        $xp = Math.max(0, $xp + _gain);
        while ($xp >= $xpToNext) {
            $xp -= $xpToNext;
            $level += 1;
            $xpToNext = Math.ceil($xpToNext * 1.25);
            UI.alert("Level up! Now level " + $level);
        }
    })()>>
    <<replace "#level">><<= $level>><</replace>>
    <<replace "#xp">><<= $xp>><</replace>>
    <<replace "#xp-to-next">><<= $xpToNext>><</replace>>
<</widget>>


:: ä¸»åŸºåœ° {"position":"800,200","size":"100,100"}
ä½ å›åˆ°äº†æ˜Ÿç•Œä¸­çš„ä¸»åŸºåœ°ã€‚è„šä¸‹æ˜¯ç²—ç²çš„,éå¸ƒç¢çŸ³çš„åœŸåœ°ï¼Œçœºæœ›è¿œå¤„å¯ä»¥çœ‹åˆ°ç’€ç’¨çš„æ˜Ÿäº‘ï¼Œæ®è¯´è¿™æ˜¯æ¥è‡ªå·¨ç¥å³°å±±è„šçš„æ™¯è±¡ã€‚
ä½ ä½äºå·¨ç¥å³°ä¸´æ—¶è¥åœ°ï¼Œç´¢æ‹‰å¡æ¢å¤äº†ä½ çš„é˜Ÿä¼ï¼Œç°åœ¨å¯ä»¥å‰å¾€å…¶ä»–åœ°åŒºæ‹œè®¿æˆ–è°ƒæ•´é˜Ÿä¼ï¼Œå‡ºé—¨æ¢ç´¢ã€‚
<<addStates "energy" $states.energy.max>>
[[å‰å¾€å‚¨ç‰©å¤„|Storage]]
[[è°ƒæ•´é˜Ÿä¼|TeamManagement]]
[[å‡†å¤‡å‡ºå‘|PrepareToDepart]]

:: TeamManagement {"position":"475,150","size":"100,100"}

:: PrepareToDepart {"position":"475,150","size":"100,100"}


:: ä¸»è¦å‰§æƒ… {"position":"375,150","size":"100,100"}
ç¬¦æ–‡å¤§é™†ï¼š


:: äº‹ä»¶ï¼šæ£®æ—å•†äºº {"position":"1600,550","size":"100,100"}
<p>ä¸€ä½æ—…è¡Œå•†äººæ­£é åœ¨å°æ¨è½¦æ—ï¼Œæ‘†å‡ºäº†å„å¼è´§ç‰©ã€‚</p>

[[å’Œå•†äººäº¤æ˜“|Market]]


:: äº‹ä»¶ï¼šè‹¹æœæ ‘æˆç†Ÿ {"position":"1700,425","size":"100,100"}
<p>ä½ æ¥åˆ°ä¸€ç‰‡ç©ºåœ°ï¼Œçœ¼å‰çš„è‹¹æœæ ‘æŒ‚æ»¡äº†æˆç†Ÿçš„æœå®ã€‚</p>
<div id="event-result"></div>

<<set _min to 1>>
<<set _max to 3>>
<<set _amount to random(_min, _max)>>

<<if not $eventFlags.apple_tree_ripe>>
<<linkreplace "é‡‡é›†è‹¹æœ">>
    <<set $eventFlags.apple_tree_ripe = true>>
    <<pickup $player "apple" _amount>>
    <<replace "#event-result">>
        <p>ä½ é‡‡é›†åˆ°äº†è‹¹æœ x<<= _amount>>ï¼</p>
    <</replace>>
<</linkreplace>>
<<else>>
<p>è¿™æ£µè‹¹æœæ ‘å·²ç»è¢«é‡‡æ‘˜è¿‡äº†ã€‚</p>
<</if>>


:: äº‹ä»¶ï¼šé‡è“ä¸› {"position":"1600,425","size":"100,100"}
<p>ä½ æ¥åˆ°ä¸€ç‰‡ç©ºåœ°ï¼Œçœ¼å‰çš„é‡è“ä¸›é•¿æ»¡äº†æˆç†Ÿçš„çº¢è‰²è“æœã€‚</p>
<div id="event-result"></div>

<<set _min to 1>>
<<set _max to 4>>
<<set _amount to random(_min, _max)>>

<<if not $eventFlags.berry_bush_harvested>>
<<linkreplace "é‡‡é›†é‡è“">>
    <<set $eventFlags.berry_bush_harvested = true>>
    <<addStates "energy" -10>>
    <<pickup $player "berry" _amount>>
    <<replace "#event-result">>
        <p>ä½ é‡‡é›†åˆ°äº†é‡è“ x<<= _amount>>ï¼</p>
    <</replace>>
<</linkreplace>>
<<else>>
<p>è¿™æ£µé‡è“ä¸›å·²ç»è¢«é‡‡æ‘˜è¿‡äº†ã€‚</p>
<</if>>


:: ä»»åŠ¡ {"position":"1425,200","size":"100,100"}
<h3>= ä¸»çº¿ä»»åŠ¡ =</h3>
<<if $MainMission.complete>>
    <p><font color="green">âœ“ $MainMission.name - å·²å®Œæˆ</font></p>
<<else>>
    <p><strong>$MainMission.name</strong></p>
    <<set _stage = $MainMission.stages[$MainMission.currentStage]>>
    <<if _stage>>
        <div style="border-left: 3px solid #FFB90F; padding-left: 10px; margin: 10px 0;">
            <p><strong>å½“å‰é˜¶æ®µ <<= $MainMission.currentStage + 1>>/<<= $MainMission.stages.length>></strong></p>
            <p><<= _stage.name>> - <<= _stage.description>></p>
            <<if !_stage.complete>>
                <p><font color="orange">[è¿›è¡Œä¸­]</font></p>
            <<else>>
                <p><font color="green">[å·²å®Œæˆ]</font></p>
            <</if>>
        </div>
    <</if>>
<</if>>

<h3>= æ´»è·ƒå§”æ‰˜ =</h3>
<<if $ActiveMissions.length > 0>>
    <<for _task range $ActiveMissions>>
        <div style="border: 1px solid #ccc; padding: 10px; margin: 5px 0; background: #f9f9f9; color: #333;">
            <strong><<= _task.name || _task.id + "å§”æ‰˜">></strong> - 
            <<if _task.complete>>
                <font color="green">[å·²å®Œæˆï¼Œå¯äº¤ä»˜]</font>
            <<else>>
                <font color="orange">[è¿›è¡Œä¸­]</font>
            <</if>>
            <<if _task.type === "collect" && _task.requiredItem>>
                <p>éœ€è¦<<= _task.requiredItemName>>ï¼š<<= _task.requiredCount>>ä¸ªï¼ˆç›®å‰æœ‰<<= $player.count(_task.requiredItem)>>ä¸ªï¼‰</p>
                <p>å¥–åŠ±ï¼š<<= _task.reward>>é‡‘å¸</p>
            <</if>>
        </div>
    <</for>>
<<else>>
    <p><font color="grey">æš‚æ— æ´»è·ƒå§”æ‰˜</font></p>
<</if>>

<p style="margin-top: 15px;"><em>å‰å¾€ä»»åŠ¡å¤§å…æ¥å–æˆ–äº¤ä»˜å§”æ‰˜</em></p>


:: å›¾é‰´ {"position":"1675,200","size":"100,100"}
C


:: åœ°å›¾1 {"position":"1225,150","size":"100,100"}
AAAtest


:: å¯¹è¯1 {"position":"625,475","size":"100,100"}
<<include æµ‹è¯•å‰§æƒ…1>>

<<dialogue tree1 'æµ‹è¯•åå­—' 'img/aaa.jpg'>>


:: æ€ç»ª {"position":"1825,200","size":"100,100"}
D


:: æˆå°± {"position":"1550,200","size":"100,100"}
<<achievementspopup>>


:: ç»Ÿè®¡ {"position":"1950,200","size":"100,100"}
<div style="padding: 15px; background: #f5f5f5; color: #333; border-radius: 8px;">
    <h2 style="text-align: center; color: #2c5aa0; margin-bottom: 20px;">ğŸ“Š æ¸¸æˆç»Ÿè®¡</h2>
    
    <div style="background: white; padding: 15px; margin: 10px 0; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <h3 style="color: #ff6b6b; margin-bottom: 10px;">ğŸ½ï¸ ç¾é£Ÿæ¢ç´¢</h3>
        <p style="font-size: 18px; margin: 5px 0;">
            å·²å“å°ç‹¬ç‰¹é£Ÿç‰©ï¼š<strong style="color: #ff6b6b;"><<= $uniqueFoodsEaten.length>></strong> ç§
        </p>
        <<if $uniqueFoodsEaten.length >= 5>>
            <p style="font-size: 14px; color: #666; margin: 5px 0;">
                ï¼ˆä½“åŠ›ä¸Šé™å¥–åŠ±ï¼š+<<= $foodMilestonesReached * 10>> ç‚¹ï¼‰
            </p>
        <</if>>
    </div>
    
    <div style="background: white; padding: 15px; margin: 10px 0; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <h3 style="color: #95e1d3; margin-bottom: 10px;">â° æ—¶é—´è®°å½•</h3>
        <p style="font-size: 18px; margin: 5px 0;">
            æ¸¸æˆå†…å·²è¿‡å¤©æ•°ï¼š<strong style="color: #95e1d3;"><<= $day>></strong> å¤©
        </p>
        <p style="font-size: 14px; color: #666; margin: 5px 0;">
            å½“å‰æ—¶é—´ï¼šç¬¬ $year å¹´ $month æœˆ $day æ—¥ $showHour:$formattedMinute
        </p>
    </div>
    
    <div style="background: white; padding: 15px; margin: 10px 0; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <h3 style="color: #ffd93d; margin-bottom: 10px;">â­ ä»»åŠ¡æˆå°±</h3>
        <p style="font-size: 16px; margin: 5px 0;">
            å®Œæˆå§”æ‰˜æ•°ï¼š<strong style="color: #ffd93d;"><<= $MissionStats.Success>></strong> ä¸ª
        </p>
        <p style="font-size: 16px; margin: 5px 0;">
            åå£°å€¼ï¼š<strong style="color: #ffd93d;"><<= $MissionStats.Fame>></strong>
        </p>
    </div>
</div>


:: æˆå°±test {"position":"1525,50","size":"100,100"}
æ­¤å¤„ä¼šè·å¾—æˆå°±
[[å›åˆ°ç¯ç«|ç¯ç«]]


:: æ›´æ–°æ—¥å¿— {"position":"375,50","size":"100,100"}
12æœˆ22æ—¥ï¼šå®Œæˆé˜Ÿå‘˜æ£€æµ‹ï¼Œæµ‹è¯•äº†å¯¹è¯æ ‘ç³»ç»Ÿ
12æœˆ23æ—¥ï¼šå®Œæˆäº†å³ä¸Šè§’å¼¹å‡ºçš„æˆå°±ç³»ç»Ÿï¼Œä»¥åŠæˆå°±ç³»ç»Ÿçš„æ£€æŸ¥å•ï¼Œä½¿ç”¨jsä¸­çš„returnå’Œnoreturn tagè¾¾åˆ°
12æœˆ24æ—¥ï¼šå®Œæˆäº†å¤šé¡µé¢å¼¹çª—ï¼Œå¹¶å®æ–½åœ¨ä¾§è¾¹æ ä¸­ã€‚
12æœˆ25æ—¥ï¼šä¸­æ–‡å¼•å·æŸ“è‰²åŠŸèƒ½ï¼Œä¾§è¾¹æ è¿›åº¦æ¡å¤–è¾¹æ¡†ï¼Œä¸hoveræ•°å€¼æ˜¾ç¤ºã€‚
ä¾§è¾¹æ æ–°å¢è¿›åº¦æ¡å¼expè·å¾—ä¸ç­‰çº§æ˜¾ç¤ºï¼Œå®æ—¶æ•°å€¼æ›´æ–°ã€‚å¯èƒ½çš„éšæ‚£ï¼šstorycaptionå†…åŒ…å«ç‰‡æ®µplayerstatsï¼Œæ¯æ¬¡æ›´æ–°player expçš„æ—¶å€™éƒ½éœ€è¦    <<replace "#story-caption">><<include "PlayerStats">>		<</replace>>
è¿™æ ·æ‰èƒ½åšåˆ°å®æ—¶æ›´æ–°ã€‚
12æœˆ26æ—¥-12æœˆ28æ—¥ï¼šè¿”å·¥
12æœˆ29æ—¥ï¼šä¿®æ”¹äº†ä¾§è¾¹æ ï¼Œç°åœ¨åªæœ‰ä½“åŠ›ä¼šæœ‰è¿›åº¦æ¡ï¼Œç»éªŒå€¼å’Œç­‰çº§ç”±åˆ«çš„ç³»ç»Ÿè¾…åŠ©å®Œæˆã€‚
å®Œæˆäº†èƒŒåŒ…ç³»ç»Ÿçš„åˆ†ç±»ä¸æœç´¢åŠŸèƒ½ï¼Œæ–°å¢äº†æ¶ˆè€—å“ä½¿ç”¨åŠŸèƒ½ï¼ˆç‚¹å‡»consumeæŒ‰é’®åï¼Œä½“åŠ›+20ï¼ŒèƒŒåŒ…ç‰©å“-1ï¼‰


æ¥ä¸‹æ¥
å¬å”¤ä¹¦çš„å†…é¡µï¼šé‡Œé¢åŒ…å«å½“å‰ä»»åŠ¡ï¼Œå›¾é‰´ï¼Œæ€ç»ªï¼Œæˆå°±ï¼Œ
æ›´æ–°åŸºåœ°ã€‚


:: æœªå‘½åç‰‡æ®µ {"position":"375,250","size":"100,100"}
<<linkreplace "é—®ä»–ä¸ºä»€ä¹ˆ">>
æ–‡æœ¬1
<</linkreplace>>
<<linkreplace "æ²‰é»˜ä¸è¯­">> 
æ–‡æœ¬
<</linkreplace>>


:: æµ‹è¯•å‰§æƒ…1 {"position":"900,475","size":"100,100"}
<<storytree tree1>>
[
    {
        "id": "start",
        "text": "ä½ å¥½ï¼Œè¿™æ˜¯ä¸€ä¸ªæµ‹è¯•å¯¹è¯ã€‚å¥½æ„Ÿåº¦ä¸º$testCharA.tieã€‚",
        "choices": [
            {
                "text": "æˆ‘æƒ³æµ‹è¯•æ¡ä»¶åˆ¤æ–­ (éœ€è¦å¥½æ„Ÿ>2)",
                "nextId": "æ¡ä»¶æµ‹è¯•",
                "condition": "$testCharA.tie > 2"
            },
            {
                "text": "æˆ‘æƒ³æµ‹è¯•æ ‡è®°ç³»ç»Ÿ",
                "nextId": "æ ‡è®°æµ‹è¯•",
                "click": "<<toggle_flag _tree2 'å·²æ‰“æ‹›å‘¼'>>"
            },
            {
                "text": "æˆ‘æƒ³æµ‹è¯•å˜é‡ç³»ç»Ÿ",
                "nextId": "å˜é‡æµ‹è¯•"
            },
            {
                "text": "å¥½æ„Ÿ+1",
                "nextId": "start",
                "click": "<<set $testCharA.tie +=1>>"
            }
        ]
    },
    {
        "id": "æ¡ä»¶æµ‹è¯•",
        "text": "ä½ é€šè¿‡äº†æ¡ä»¶æ£€æŸ¥ï¼",
        "choices": [
            {
                "text": "è¿”å›å¼€å§‹",
                "nextId": "start"
            }
        ]
    },
    {
        "id": "æ ‡è®°æµ‹è¯•",
        "text": "è®©æˆ‘ä»¬çœ‹çœ‹ä½ æ˜¯å¦æœ‰'å·²æ‰“æ‹›å‘¼'çš„æ ‡è®°ã€‚\n<<if setup.hasFlag('tree2','å·²æ‰“æ‹›å‘¼')>>ä½ ç¡®å®æœ‰è¿™ä¸ªæ ‡è®°ï¼<<else>>ä½ è¿˜æ²¡æœ‰è¿™ä¸ªæ ‡è®°ã€‚<</if>>",
        "choices": [
            {
                "text": "è¿”å›å¼€å§‹",
                "nextId": "start"
            }
        ]
    },
    {
        "id": "å˜é‡æµ‹è¯•",
        "text": "è®©æˆ‘ä»¬è®¾ç½®ä¸€äº›å˜é‡ã€‚",
        "choices": [
            {
                "text": "è®¾ç½®ä¸´æ—¶å˜é‡",
                "nextId": "start",
                "click": "<<set_tmp _tree2 'testTemp' true>>"
            },
            {
                "text": "è®¾ç½®æŒä¹…å˜é‡",
                "nextId": "start",
                "click": "<<set_var _tree2 'testVar' 100>>"
            }
        ]
    }
]
<</storytree>>


:: æµ‹è¯•å‰§æƒ…2 {"position":"925,325","size":"100,100"}
ä½ å¥½ï¼Œè¿™é‡Œæ˜¯æµ‹è¯•å‰§æƒ…2
å“‡å“¦
[[è¿”å›ç¯ç«|ç¯ç«]]


:: æµ‹è¯•æˆå°± {"position":"1625,50","size":"100,100"}
<<link"è·³è½¬åˆ°test""æˆå°±test">><<achievement "æˆå°±ID20">><</link>>


:: ç¯ç« {"position":"625,350","size":"100,100"}
â€œæ¬¢è¿æ¥åˆ°ç¯ç«ï¼Œä½ å¯ä»¥åœ¨è¿™é‡Œæ¢å¤ä½“åŠ›ç­‰â€
[[ä»»åŠ¡å§”æ‰˜|ä»»åŠ¡å§”æ‰˜åˆ—è¡¨]]
<<link"è·³è½¬åˆ°æˆå°±test""æˆå°±test">><<achievement "æˆå°±ID20">><</link>>
<<link"é•€é‡‘ç¥¨åˆ¸æŠ½å¥–ï¼ˆå½“å‰ç¥¨åˆ¸ï¼š$goldTicketså¼ ï¼‰""é•€é‡‘æŠ½å¥–">><</link>>
[[Go to the map|Map]]
[[å›åˆ°åŸºåœ°|ä¸»åŸºåœ°]]
<img src="img/aaa.jpg">
<<if $teamList.includes("å‘æ—¥è‘µ") && $testCharA.tie >= 1 && not hasVisited('æµ‹è¯•å‰§æƒ…1')>>
[[å¥½æ„Ÿä¸º1ï¼Œè¿›å…¥æµ‹è¯•å‰§æƒ…1|å¯¹è¯1]]
<</if>>
<<if $teamList.includes("å‘æ—¥è‘µ") && $testCharA.tie >= 2 && not hasVisited('æµ‹è¯•å‰§æƒ…2')>>
[[å¥½æ„Ÿä¸º2ï¼Œè¿›å…¥æµ‹è¯•å‰§æƒ…2|æµ‹è¯•å‰§æƒ…2]]
<</if>>


:: é•€é‡‘æŠ½å¥– [nobr] {"position":"725,350","size":"100,100"}
<h2>é•€é‡‘æŠ½å¥–ç³»ç»Ÿ</h2>
<p>å½“å‰æ‹¥æœ‰çš„é•€é‡‘ç¥¨åˆ¸ï¼š<strong>$goldTickets</strong> å¼ </p>

<<if $goldTickets > 0>>
<button id="lottery-btn">è¿›è¡ŒæŠ½å¥–ï¼ˆæ¶ˆè€—1å¼ ç¥¨åˆ¸ï¼‰</button>
<div id="lottery-result" style="margin-top: 20px;"></div>

<<script>>
setTimeout(function() {
    $(document).on('click', '#lottery-btn', function() {
        if (State.variables.goldTickets <= 0) {
            $('#lottery-result').html('<p style="color: red;">ç¥¨åˆ¸ä¸è¶³ï¼</p>');
            return;
        }
        
        State.variables.goldTickets--;
        
        var totalProbability = 0;
        setup.lotteryPrizes.forEach(function(prize) {
            totalProbability += prize.probability;
        });
        
        var random = Math.random() * totalProbability;
        var cumulative = 0;
        var winPrize = setup.lotteryPrizes[0];
        
        for (var i = 0; i < setup.lotteryPrizes.length; i++) {
            cumulative += setup.lotteryPrizes[i].probability;
            if (random < cumulative) {
                winPrize = setup.lotteryPrizes[i];
                break;
            }
        }
        
        var prizeName = setup.Item.has(winPrize.itemId) ? setup.Item.get(winPrize.itemId).name : winPrize.itemId;
        
        State.variables.player.pickup(winPrize.itemId, winPrize.quantity);
        
        var resultHTML = '<div style="text-align: center; padding: 30px; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border-radius: 15px; box-shadow: 0 10px 30px rgba(255, 215, 0, 0.3); border: 3px solid gold;">' +
            '<h3 style="color: #FFD700; font-size: 28px; margin: 0 0 15px 0; text-shadow: 2px 2px 4px rgba(0,0,0,0.7);">âœ¨ æ­å–œï¼âœ¨</h3>' +
            '<p style="font-size: 24px; color: #FFD700; font-weight: bold; margin: 15px 0; text-shadow: 1px 1px 3px rgba(0,0,0,0.7);">' + prizeName + ' Ã—' + winPrize.quantity + '</p>' +
            '<p style="font-size: 16px; color: #87CEEB; margin: 10px 0;">å‰©ä½™ç¥¨åˆ¸ï¼š<span style="color: #FFD700; font-weight: bold; font-size: 18px;">' + State.variables.goldTickets + '</span> å¼ </p>' +
        '</div>';
        
        $('#lottery-result').html(resultHTML);
        
        $('p').first().html('å½“å‰æ‹¥æœ‰çš„é•€é‡‘ç¥¨åˆ¸ï¼š<strong>' + State.variables.goldTickets + '</strong> å¼ ');
    });
}, 100);
<</script>>

<<else>>
<p style="color: red;">æš‚æ— é•€é‡‘ç¥¨åˆ¸ï¼Œå®Œæˆæˆå°±å¯è·å¾—ç¥¨åˆ¸ï¼</p>
<</if>>

[[è¿”å›ç¯ç«|ç¯ç«]]



:: StoryScript [script]
/* twine-user-script #1: "simple-inventory.js" */
// Simple Inventory, for SugarCube 2, by Chapel
// v3.0.1, 2024-07-22, 8c9749dbafa5f12948d743a8dedd4e1c74bb9e26
;"use strict";function _typeof(t){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},_typeof(t)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,_toPropertyKey(i.key),i)}}function _createClass(t,e,n){return e&&_defineProperties(t.prototype,e),n&&_defineProperties(t,n),Object.defineProperty(t,"prototype",{writable:!1}),t}function _toPropertyKey(t){var e=_toPrimitive(t,"string");return"symbol"==_typeof(e)?e:String(e)}function _toPrimitive(t,e){if("object"!=_typeof(t)||!t)return t;var n=t[Symbol.toPrimitive];if(void 0!==n){var i=n.call(t,e||"default");if("object"!=_typeof(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}!function(){var t={description:"",handler:null,displayName:"",consumable:!0,unique:!1,permanent:!1},e=new Map,n=function(){function n(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:clone(t),r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];if(_classCallCheck(this,n),!e||"string"!=typeof e)throw new Error("invalid item ID");if("object"!==_typeof(i))throw new Error("invalid item definition");Object.assign(this,Object.assign({},t,i)),this.id=e,this._tags=r instanceof Array?r:"string"==typeof r?[r]:[]}return _createClass(n,[{key:"tags",get:function(){return this._tags}},{key:"hasTag",value:function(t){return this._tags.includes(t)}},{key:"hasAllTags",value:function(){return this._tags.includesAll([].slice.call(arguments).flat(1/0))}},{key:"hasAnyTags",value:function(){return this._tags.includesAny([].slice.call(arguments).flat(1/0))}},{key:"name",get:function(){return this.displayName||this.id},set:function(t){this.displayName=t}},{key:"use",value:function(){return"string"==typeof this.handler?$.wiki(this.handler):"function"==typeof this.handler&&this.handler(this),this}},{key:"inspect",value:function(){return Dialog.setup(this.name,"simple-inventory item-description"),Dialog.wiki(this.description),Dialog.open(),this}}],[{key:"is",value:function(t){return t instanceof n}},{key:"add",value:function(t,i,r){var a=new n(t,i,r);return e.set(t,a),a}},{key:"get",value:function(t){return e.get(t)}},{key:"has",value:function(t){return e.has(t)}},{key:"list",get:function(){return e}}]),n}();setup.Item=n,window.Item=window.Item||n}(),function(){var t=setup.Item,e=!1,n="&hellip;",i={inspect:"Inspect",use:"Use",drop:"Drop",stack:"stack",take:"Take",give:"Give",stackPre:"&nbsp;&times;&nbsp;",stackPost:"&nbsp;"},r={};function a(e){return t.has(e)&&t.get(e).unique}var s=function(){function s(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];_classCallCheck(this,s),this.data=clone(t),this._tags=e instanceof Array?e:"string"==typeof e?[e]:[]}return _createClass(s,[{key:"emit",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return s.emit(t,this,e),this}},{key:"array",get:function(){var t=this,e=[];return Object.keys(this.data).forEach((function(n){if(e.push(n),t.data[n]>1)for(var i=1;i<t.data[n];i++)e.push(n)})),e}},{key:"list",get:function(){return Object.keys(this.data)}},{key:"length",get:function(){return this.array.length}},{key:"uniqueLength",get:function(){return this.list.length}},{key:"table",get:function(){return this.data}},{key:"tags",get:function(){return this._tags}},{key:"hasTag",value:function(t){return this._tags.includes(t)}},{key:"hasAllTags",value:function(){return this._tags.includesAll([].slice.call(arguments).flat(1/0))}},{key:"hasAnyTags",value:function(){return this._tags.includesAny([].slice.call(arguments).flat(1/0))}},{key:"count",value:function(t){return t?this.data[t]||0:this.length}},{key:"has",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;return this.data[t]>=e}},{key:"hasAll",value:function(){var t=this;return[].slice.call(arguments).flat(1/0).every((function(e){return t.has(e)}))}},{key:"hasAny",value:function(){var t=this;return[].slice.call(arguments).flat(1/0).some((function(e){return t.has(e)}))}},{key:"compare",value:function(t){var e=this,n=s.itemset(t);return Object.keys(n).every((function(t){return e.has(t,n[t])}))}},{key:"merge",value:function(t){var e=this,n=s.itemset(t);return Object.keys(n).forEach((function(t){s.change(e,t,n[t])})),n}},{key:"unmerge",value:function(t){var e=this,n={},i=s.itemset(t);return Object.keys(i).forEach((function(t){e.has(t,i[t])?n[t]=i[t]:e.has(t)&&(n[t]=e.count(t)),s.change(e,t,i[t],!0)})),n}},{key:"pickup",value:function(){var t=this.merge(s.parseArgList.apply(null,arguments));return this.emit("update",{delta:t}),this}},{key:"drop",value:function(){var t=this.unmerge(s.parseArgList.apply(null,arguments));return this.emit("update",{delta:t}),this}},{key:"empty",value:function(){var t=clone(this.data);return this.data={},this.emit("update",{delta:t}),this}},{key:"transfer",value:function(t){var e=s.parseArgList.apply(null,[].slice.call(arguments).slice(1));if(!s.is(t))throw new TypeError("target inventory is not an inventory instance");var n=this.unmerge(e);return t.merge(n),this.emit("update",{target:t,delta:n}),this}},{key:"isEmpty",value:function(){return 0===this.length}},{key:"iterate",value:function(t){var e=this;return"function"!=typeof t||this.list.forEach((function(n){t(n,e.data[n])})),this}},{key:"use",value:function(e){if(t.has(e)){var n=t.get(e);if(n.use(),n.consumable){s.change(this,e,1,!0);var i={};i[e]=1,this.emit("update",{delta:i})}return this.emit("use",{item:n}),this}}},{key:"clone",value:function(){return new s(this.data||{},this._tags||[])}},{key:"toJSON",value:function(){return JSON.reviveWrapper("new setup.Inventory("+JSON.stringify(this.data)+", "+JSON.stringify(this._tags)+")")}}],[{key:"confirm",get:function(){return e},set:function(t){e="string"==typeof t&&"all"===t.trim().toLowerCase()?"all":"string"==typeof t&&"stack"===t.trim().toLowerCase()?"stack":!!t}},{key:"emptyMessage",get:function(){return n},set:function(t){"string"==typeof t&&(n=t)}},{key:"strings",get:function(){return Object.assign(clone(i),r)},set:function(t){"object"===_typeof(t)&&(r=Object.assign(r,clone(t)))}},{key:"change",value:function(e,n){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,r=arguments.length>3&&void 0!==arguments[3]&&arguments[3];if(0!==i){if(e instanceof s&&(e=e.data),"object"!==_typeof(e)){if(e)throw new TypeError("cannot access inventory data");e={}}if(!(o=n)||"string"!=typeof o||!o.trim())throw new TypeError("invalid item name/id");var o;if("number"==typeof i&&!Number.isNaN(i)&&Number.isInteger(i)||(i=1),r&&(i*=-1),i>0){if(Object.keys(e).includes(n)&&a(n))return;i>1&&a(n)&&(i=1),Object.keys(e).includes(n)||(e[n]=0),e[n]+=i}else{if(function(e){return t.has(e)&&t.get(e).permanent}(n))return;Object.keys(e).includes(n)&&"number"==typeof e[n]&&(e[n]+=i),e[n]<=0&&delete e[n]}return e}}},{key:"itemset",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(s.is(t)&&(t=t.data),"object"!==_typeof(t))return{};var e={};return Object.keys(t).forEach((function(n){"number"==typeof t[n]&&Number.isInteger(t[n])&&0!==t[n]&&(e[n]=t[n])})),e}},{key:"parseArgList",value:function(){var t=[].slice.call(arguments).flat(1/0);if(t.length%2!=0)throw new Error("item sets should be pairs of item IDs and numbers");var e={};return t.forEach((function(n,i){i%2==0&&(e[n]=t[i+1])})),e}},{key:"is",value:function(t){return t instanceof s}},{key:"emit",value:function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};$(document).trigger(Object.assign({type:":inventory-"+t+".simple-inventory",inventory:e,target:null,delta:{},item:null},n))}},{key:"create",value:function(t,e){return new s(t,e)}}]),s}();setup.Inventory=s,window.Inventory=window.Inventory||s}(),function(){var t=setup.Item,e=setup.Inventory;function n(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"Alert",a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"Are you sure?";if(!t||"function"!=typeof t)throw new Error("Invalid confirmation callback!");if(e.confirm)if("all"!==e.confirm||"all"===i)if("stack"!==e.confirm||i){var s={display:"inline-block",float:"right"},o=$(document.createElement("div")),u=$(document.createElement("p")).append(a),l=$(document.createElement("div")).addClass("confirmation-buttons"),c=$(document.createElement("button")).append("Okay").addClass("confirm-yes").css(Object.assign(s,{"margin-right":"0.5rem"})),d=$(document.createElement("button")).append("Cancel").addClass("confirm-no").css(s);t&&"function"==typeof t&&c.ariaClick(t),n&&"function"==typeof n&&d.ariaClick(n),l.append(d,c),o.append(u,l),Dialog.setup(r,"simple-inventory confirmation"),Dialog.append(o),Dialog.open()}else t();else t();else t()}function i(t){var e=$(document.createElement("span")).addClass("spacer");return t&&e.wiki(""+t),e}function r(t,i){var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;return"give"===String(i).toLowerCase().trim()?i=e.strings.give:"take"===String(i).toLowerCase().trim()?i=e.strings.take:i&&"drop"!==String(i).toLowerCase().trim()||(i=e.strings.drop),$(document.createElement(r?"button":"a")).addClass("all-link drop-link").wiki(i+" all").ariaClick((function(){t.isEmpty()||n((function(){a&&e.is(a)?(a.merge(t),t.empty()):t.empty(),Dialog.close()}),(function(){Dialog.close()}),!0)}))}function a(a){var s,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{description:!0,use:!0,transfer:null,drop:!0,all:!0,stack:!0,dropActionText:"",classes:""},u=$(document.createElement("ul")).addClass("simple-inventory-list");if(a.length){if(s=a.list.map((function(r){var s=[],u=r;t.has(r)&&(u=t.get(r).name),o.description&&t.has(r)&&t.get(r).description?s.push(function(n,i,r){var a=arguments.length>3&&void 0!==arguments[3]&&arguments[3];return r=r||e.strings.inspect,$(document.createElement(a?"button":"a")).addClass("inspect-link").wiki(""+r).ariaClick((function(){t.get(i).inspect()}))}(a,r,u)):s.push($(document.createElement("span")).append(t.has(r)?t.get(r).name:r).addClass("item-name")),s.push(function(t,n,i,r){var a=$(document.createElement("span")),s=t.count(n);return i=i||e.strings.stackPre,r=r||e.strings.stackPost,1==s?a.addClass("item-count single"):a.addClass("item-count multi"),a.append(""+i+(s||0)+r)}(a,r)),o.use&&t.has(r)&&t.get(r).handler?s.push(function(t,n,i){var r=arguments.length>3&&void 0!==arguments[3]&&arguments[3];return i=i||e.strings.use,$(document.createElement(r?"button":"a")).addClass("use-link").wiki(""+i).ariaClick((function(){t.use(n)}))}(a,r)):s.push(i()),(o.transfer&&e.is(o.transfer)||o.drop)&&!function(e){return t.has(e)&&t.get(e).permanent}(r)?(s.push(function(t,i,r){var a=arguments.length>3&&void 0!==arguments[3]&&arguments[3],s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;return"give"===String(r).toLowerCase().trim()?r=e.strings.give:"take"===String(r).toLowerCase().trim()?r=e.strings.take:r&&"drop"!==String(r).toLowerCase().trim()||(r=e.strings.drop),$(document.createElement(a?"button":"a")).addClass("drop-link").wiki(""+r).ariaClick((function(){n((function(){s&&e.is(s)?t.transfer(s,i,1):t.drop(i,1),Dialog.close()}),(function(){Dialog.close()}))}))}(a,r,o.dropActionText,!1,o.transfer||null)),a.count(r)>1&&o.stack?s.push(function(t,i,r){var a=arguments.length>3&&void 0!==arguments[3]&&arguments[3],s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;return"give"===String(r).toLowerCase().trim()?r=e.strings.give:"take"===String(r).toLowerCase().trim()?r=e.strings.take:r&&"drop"!==String(r).toLowerCase().trim()||(r=e.strings.drop),r=r+"&nbsp;"+e.strings.stack,$(document.createElement(a?"button":"a")).addClass("stack-link drop-link").wiki(""+r).ariaClick((function(){n((function(){s&&e.is(s)?t.transfer(s,i,t.count(i)):t.drop(i,t.count(i)),Dialog.close()}),(function(){Dialog.close()}))}))}(a,r,o.dropActionText,!1,o.transfer||null)):s.push(i())):s.push(i());var l=r.normalize().toLowerCase().replace(/\s+/g,"-");return $(document.createElement("li")).append(s).addClass("simple-inventory-listing").attr({"data-item-id":l,"data-keyword":u})})),o.all){var l=$(document.createElement("li")).addClass("all-listing simple-inventory-listing").append([i("&mdash;"),i(),i(),r(a,o.dropActionText,!1,o.transfer||null)]);s.push(l)}}else s=$(document.createElement("li")).addClass("simple-inventory-listing").append($(document.createElement("span")).wiki(e.emptyMessage));return u.append(s),u}e.prototype.interface=function(){var t,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=this,r=$(document.createElement("div")).addClass("simple-inventory-wrapper");return r.append(a(this,e)),$(document).on(":inventory-update.simple-inventory.gui-built-in",(function(){r.length?r.empty().append(a(i,e)):$(document).off(":inventory-update.simple-inventory.gui-built-in")})),n&&n instanceof $?t=n:n&&(t=$(n)),t&&r.appendTo(t),r}}(),function(){setup.Inventory,setup.Item;var t=".simple-inventory-userland",e=":inventory-update.simple-inventory"+t,n=":inventory-use.simple-inventory"+t;function i(t){return t&&"function"==typeof t}Object.assign(setup.Inventory,{events:{update:{on:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";i(t)&&$(document).on(e+n,t)},one:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";i(t)&&$(document).one(e+n,t)},off:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";$(document).off(e+t)}},use:{on:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";i(t)&&$(document).on(n+e,t)},one:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";i(t)&&$(document).one(n+e,t)},off:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";$(document).off(n+t)}}}})}(),function(){var t=":";function e(e){var n=function(t){return t.replace(/\r+/g,"\n").replace(/\n+/,"\n").replace(/ +/g," ").trim().split(/\n/g)}(e),i={};return n.forEach((function(e){if(e&&e.trim()&&e.includes(t)){var n=e.trim().split(t);i[n[0].trim()]=n[1].trim()}})),i}var n=function(t){try{return Story.has(t)?e(Story.get(t).text):{}}catch(t){return console.error(t.message,t),{}}}("inventory.strings");n.empty&&"string"==typeof n.empty&&n.empty.trim()&&(setup.Inventory.emptyMessage=n.empty,delete n.empty),setup.Inventory.strings=n||{}}(),function(){var t=setup.Item,e=setup.Inventory;function n(t){return t&&"string"==typeof t&&t.length>=2&&("$"===t[0]||"_"===t[0])}function i(t){if(n(t)&&(t=State.getVar(t)),e.is(t))return t}Macro.add(["item","consumable"],{tags:["description","tags","unique","permanent"],handler:function(){var e,n,i,r,a=null,s=!1,o=!1,u=!1;if(State.length>0)return this.error("items must be defined in `StoryInit` or story JavaScript!");if(!this.args[0]||"string"!=typeof this.args[0]||!this.args[0].trim())return this.error("invalid item ID");if(e=this.args[0].trim(),"consumable"===this.name&&(a=this.payload[0].contents||null,s=!0),this.args[1]&&(n=this.args[1]),this.payload.length>1){var l=this.payload.find((function(t){return"description"===t.name})),c=this.payload.find((function(t){return"tags"===t.name})),d=this.payload.find((function(t){return"unique"===t.name})),f=this.payload.find((function(t){return"permanent"===t.name}));l&&(i=l.contents.trim()),c&&(r=c.args.flat(1/0)),d&&(o=!0),f&&(u=!0)}t.add(e,{displayName:n||"",description:i||"",handler:a,consumable:s,unique:o,permanent:u},r)}}),Macro.add("newinv",{handler:function(){var t=this.args.raw.trim().split(" ").first().replace(/["']/g,"").trim();if(!n(t))return this.error("argument must be a story or temporary variable!");State.setVar(t,new e({},this.args.flat(1/0).slice(1)))}}),Macro.add(["pickup","drop"],{handler:function(){var t=i(this.args[0]);return t?this.args.length<3?this.error("no items to pick up were provided"):void t[this.name](this.args.slice(1)):this.error("first argument must be a valid inventory!")}}),Macro.add("dropall",{handler:function(){var t=i(this.args[0]);if(!t)return this.error("first argument must be a valid inventory!");t.empty()}}),Macro.add(["transfer","merge","unmerge"],{handler:function(){var t=i(this.args[0]);if(!t)return this.error("first argument must be a valid inventory!");var e=i(this.args[1]);if(!e)return this.error("second argument must be a valid inventory!");if("transfer"===this.name){if(this.args.length<4)return this.error("no items to transfer were provided");t.transfer(e,this.args.slice(2))}else t[this.name](e)}}),Macro.add(["inv","take","give"],{handler:function(){var t=null,n=i(this.args[0]);if(!n)return this.error("first argument must be a valid inventory!");this.args[1]&&i(this.args[1])&&(t=i(this.args[1]));var r={description:this.args.includesAny("inspect","description"),use:this.args.includes("use"),transfer:t,drop:this.args.includes("drop"),all:this.args.includes("all"),stack:this.args.includes("stack"),dropActionText:"inv"===this.name?"Drop":e.strings[this.name.trim().toLowerCase()],classes:"macro-".concat(this.name)};n.interface(r,$(this.output))}})}(),function(){var t=setup.Item,e=setup.Inventory;function n(t,e,n){if("object"!==_typeof(e))throw new TypeError("the extension should be a plain generic object holding the properties and methods you want to add");Object.keys(e).forEach((function(i){if(t[i]&&!n)throw new Error('Cannot override existing property "'+i+'"!');t[i]=e[i]}))}Object.assign(e,{extend:function(t){n(e,t,arguments.length>1&&void 0!==arguments[1]&&arguments[1])},extendPrototype:function(t){var i=arguments.length>1&&void 0!==arguments[1]&&arguments[1];n(e.prototype,t,i)}}),Object.assign(t,{extend:function(e){n(t,e,arguments.length>1&&void 0!==arguments[1]&&arguments[1])},extendPrototype:function(e){var i=arguments.length>1&&void 0!==arguments[1]&&arguments[1];n(t.prototype,e,i)}})}();
// End Simple Inventory
/* twine-user-script #2: "Story JavaScript" */
Config.ui.stowBarInitially = false;

//ä¾§è¾¹æ æ˜¾ç¤ºhoverå±æ€§
setup.updateTooltip = function(stateId) {
    $(document).on('mouseenter', '#bar-' + stateId, function(e) {
        var states = State.variables.states[stateId];
        var tooltip = $(this).find('.state-tooltip');
        tooltip.text(states.value + '/' + states.max).show();
    }).on('mousemove', '#bar-' + stateId, function(e) {
        var tooltip = $(this).find('.state-tooltip');
        var offset = $(this).offset();
        tooltip.css({
            left: e.pageX - offset.left,
            top: e.pageY - offset.top - 30
        });
    }).on('mouseleave', '#bar-' + stateId, function() {
        $(this).find('.state-tooltip').hide();
    });
};

//noreturn
$(document).on(':passagestart', function (ev) {
    if (!ev.passage.tags.includes('noreturn')) {
        State.variables.return = ev.passage.name;
    }
});

// äº‹ä»¶é€‰æ‹©ï¼šæ ¹æ®äº‹ä»¶çš„ weight è¿›è¡ŒåŠ æƒéšæœºé€‰æ‹©
setup.pickEventForLocation = function(locId) {
    var loc = setup.locations[locId];
    if (!loc || !loc.events || !loc.events.length) {
        return null;
    }
    var list = loc.events;
    var total = 0;
    var weights = list.map(function(eid){
        var w = (setup.events[eid] && setup.events[eid].weight) ? setup.events[eid].weight : 1;
        total += w;
        return w;
    });
    var r = Math.random() * total;
    for (var i = 0; i < list.length; i++) {
        if (r < weights[i]) {
            return list[i];
        }
        r -= weights[i];
    }
    return list[0];
};

//å¯åˆ‡æ¢tabçš„å¼¹çª—
/*éœ€è¦å‡ ä¸ªå¼¹çª—åˆ‡æ¢ï¼Œå°±è®¾å‡ ä¸ªIDï¼Œç„¶åå†™å¯¹åº”çš„å¼¹çª—é¡µé¢åï¼ˆæ³¨æ„ï¼šéœ€è¦ä¸€ä¸ªåŒåçš„é¡µé¢ï¼‰
*/
window.multiplePopUpTab = function(page, ID) {
    let content = "";
    let pages = {};

    switch (ID) {
        case "1":
            pages = {
                page1: "ä»»åŠ¡",
                page2: "æˆå°±",
              	page3: "å›¾é‰´",
              	page4: "æ€ç»ª",
              	page5: "ç»Ÿè®¡"
            };
            break;
        case "2":
            pages = {
                page1: "ä¼ é—»",
                page2: "æœªå®Œæˆä»»åŠ¡",
                page3: "å·²å®Œæˆä»»åŠ¡"
            };
            break;
        default:
            content = `
                <div class="popup-content">
                    <p>æœªçŸ¥é¡µé¢ã€‚</p>
                </div>
            `;
    }

    if (pages[page]) {
        content = Story.get(pages[page]).processText(); 
    } else {
        console.error("æœªçŸ¥é¡µé¢ï¼");
        return;
    }

    if (ID === "1") {
        Dialog.create(`
            <div class="title-buttons">
                <button onclick="multiplePopUpTab('page1', '1')" class="popup-button ${page === 'page1' ? 'active' : ''}">ä»»åŠ¡</button>
                <button onclick="multiplePopUpTab('page2', '1')" class="popup-button ${page === 'page2' ? 'active' : ''}">æˆå°±</button>
                <button onclick="multiplePopUpTab('page3', '1')" class="popup-button ${page === 'page3' ? 'active' : ''}">å›¾é‰´</button>
                <button onclick="multiplePopUpTab('page4', '1')" class="popup-button ${page === 'page4' ? 'active' : ''}">æ€ç»ª</button>
                <button onclick="multiplePopUpTab('page5', '1')" class="popup-button ${page === 'page5' ? 'active' : ''}">ç»Ÿè®¡</button>
            </div>
        `, "map-dialog");
    } else if (ID === "2") {
        Dialog.create(`
            <div class="title-buttons">
                <button onclick="multiplePopUpTab('page1', '2')" class="popup-button ${page === 'page1' ? 'active' : ''}">ä¼ é—»</button>
                <button onclick="multiplePopUpTab('page2', '2')" class="popup-button ${page === 'page2' ? 'active' : ''}">æœªå®Œæˆä»»åŠ¡</button>
                <button onclick="multiplePopUpTab('page3', '2')" class="popup-button ${page === 'page3' ? 'active' : ''}">å·²å®Œæˆä»»åŠ¡</button>
            </div>
        `, "map-dialog");
    }

    Dialog.wiki(content);
    Dialog.open();
};

/* twine-user-script #1: "storytree.js" */
/* StoryTree, Ver.0.1.9, By BlackStar */
/// Build Date: 2025-01-24T20:25:19.582Z
(()=>{(()=>{function e(t){return e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e(t)}function t(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function r(e,t){for(var r=0;r<t.length;r++){var s=t[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,n(s.key),s)}}function s(e,t,s){return t&&r(e.prototype,t),s&&r(e,s),Object.defineProperty(e,"prototype",{writable:!1}),e}function n(t){var r=function(t,r){if("object"!=e(t)||!t)return t;var s=t[Symbol.toPrimitive];if(void 0!==s){var n=s.call(t,r||"default");if("object"!=e(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===r?String:Number)(t)}(t,"string");return"symbol"==e(r)?r:r+""}!function(){var e,r,a,i=new(function(){return s((function e(){t(this,e),this.placeholders={strings:new Map,comments:new Map,templates:new Map},this.patterns={comments:/(\/\*[\s\S]*?\*\/|\/\/.*)/g,templates:/(`(?:\\[\s\S]|[^\\`])*?`)/g,strings:/(["'])(?:\\.|[^\\])*?\1/g,replacements:[{pattern:/(?<=[\s\n\t{}()\[\],;<>!=+\-*/%:|&]|^)\$(\w+)\b/g,replace:function(e,t){return"SugarCube.State.variables.".concat(t)}},{pattern:/(?<=[\s\n\t{}()\[\],;<>!=+\-*/%:|&]|^)_(\w+)\b/g,replace:function(e,t){return"SugarCube.State.temporary.".concat(t)}},{pattern:/(?<=[\s\n\t{}()\[\],;<>!=+\-*/%:|&]|^)setup\b/g,replace:function(){return"SugarCube.setup"}}]}}),[{key:"createPlaceholder",value:function(e,t){var r=this.placeholders[e],s=r.size+1,n="@@".concat(e.toUpperCase(),"_").concat(s,"@@");return r.set(n,t),n}},{key:"replace",value:function(e,t,r){var s=this;return e.replace(t,(function(e){return s.createPlaceholder(r,e)}))}},{key:"restore",value:function(e,t){var r=this.placeholders[t];return e.replace(new RegExp("@@".concat(t.toUpperCase(),"_\\d+@@"),"g"),(function(e){return r.get(e)}))}},{key:"process",value:function(e){try{Object.values(this.placeholders).forEach((function(e){return e.clear()}));var t=e;return t=this.replace(t,this.patterns.comments,"comments"),t=this.replace(t,this.patterns.templates,"templates"),t=this.replace(t,this.patterns.strings,"strings"),this.patterns.replacements.forEach((function(e){var r=e.pattern,s=e.replace;t=t.replace(r,s)})),t=this.restore(t,"strings"),t=this.restore(t,"templates"),t=this.restore(t,"comments")}catch(t){return console.error("å¤„ç†ä»£ç æ—¶å‘ç”Ÿé”™è¯¯:",t),e}}}])}()),o=function(){return s((function e(r){var s=this;t(this,e),this.nodes=new Map,r.forEach((function(e){try{e.choices&&(e.choices=e.choices.map((function(e){if(e.condition&&"string"==typeof e.condition){var t=i.process(e.condition);e.condition=new Function("flags","temp","vars","session","return ".concat(t))}return e}))),s.nodes.set(e.id,e)}catch(t){console.error("Error setting node:",e.id,t)}}))}),[{key:"getNode",value:function(e){return this.nodes.get(e)}},{key:"getAllNodes",value:function(){return Array.from(this.nodes.values())}}])}();e=o,a={},(r=n(r="trees"))in e?Object.defineProperty(e,r,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[r]=a;var c=function(){function e(r){var s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"start",n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e.progress(s);t(this,e),this.varname=r,this.start=s,this.progress=n}return s(e,[{key:"visit",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return e=null!=e?e:this.progress.current,this.tree.nodes.has(e)?(this.progress.visits[e]=(this.progress.visits[e]||0)+t,this.progress.visits[e]):0}},{key:"tree",get:function(){var e=State.getVar(this.varname);if(!e)throw new Error("Tree ".concat(this.varname," not found"));return e}},{key:"current",get:function(){return this.tree.getNode(this.progress.current)},set:function(e){this.progress.current=e}},{key:"choices",get:function(){var e=this,t=this.current;return null!=t&&t.choices?t.choices.map((function(t,r){return{index:r,text:t.text,available:"function"!=typeof t.condition||t.condition(e.progress.state.flags,e.progress.state.temporary,e.progress.state.variables,e)}})).filter((function(e){return e.available})).map((function(e){return{index:e.index,text:e.text}})):[]}},{key:"isInStart",get:function(){return"start"===this.progress.current}},{key:"make",value:function(e){var t=this.current;if(null==t||!t.choices)return!1;var r=t.choices[e];return!(!r||r.condition&&!r.condition(this.progress.state.flags,this.progress.state.temporary,this.progress.state.variables,this))&&(r.click&&$.wiki(r.click),this.progress.current=r.nextId,this.progress.state.temporary={},this.visit(r.nextId,1),$(document).trigger("storytree:choice",{session:this,choice:r,index:e}),!0)}},{key:"clone",value:function(){return new e(this.varname,this.start,this.progress)}},{key:"toJSON",value:function(){return Serial.createReviver(String.format("new {0}({1},{2},{3})","setup.GameSession",JSON.stringify(this.varname),JSON.stringify(this.start),JSON.stringify(this.progress)))}}],[{key:"progress",value:function(e){return{current:e,state:{flags:[],temporary:{},variables:{}},visits:{}}}}])}();window.SCProcessor=window.SCProcessor||i,window.StoryTree=window.StoryTree||o,window.GameSession=window.GameSession||c,setup.StoryTree=o,setup.GameSession=c,setup.SCProcessor=i}()})(),(()=>{(function(){function getVarname(e){return e.raw.trim().split(" ")[0].replace(/["'$_]/g,"").trim()}function getSession(e){var t=State.getVar("$dialogue_sessions");return t||(t={},State.setVar("$dialogue_sessions",t)),t[e]}function hasFlag(e,t){var r=getSession(e.replace(/[$_]/,""));return!!r&&r.progress.state.flags.includes(t)}function getSVar(e,t){var r=getSession(e);return r?r.progress.state.variables[t]:null}function setSVar(e,t,r){var s=getSession(e);if(!s)return null;s.progress.state.variables[t]=r}function getSTmp(e,t){var r=getSession(e);return r?r.progress.state.temporary[t]:null}function setSTmp(e,t,r){var s=getSession(e);if(!s)return null;s.progress.state.temporary[t]=r}Macro.add("storytree",{tags:null,handler:function handler(){var varname=getVarname(this.args),content=this.payload[0].contents.trim(),contentWithBrackets=content.startsWith("[")?content:"[".concat(content,"]");eval("State.temporary.".concat(varname," = new setup.StoryTree(").concat(contentWithBrackets,");"))}}),Macro.add("dialogue",{handler:function(){if(this.args.length<1)return this.error("Dialogue: varname is required");var e=getVarname(this.args),t=this.args[1]||null,r=this.args[2]||null,s=this.args[3]||"start",n=State.getVar("$dialogue_sessions");n||(n={},State.setVar("$dialogue_sessions",n));var a=n[e];a||(a=new GameSession("_".concat(e),s),n[e]=a);var i=$("<div>").addClass("story-dialogue").attr("id",e),o=$("<div>").addClass("avatar"),c=$("<div>").addClass("name"),u=$("<div>").addClass("content"),l=$("<div>").addClass("choices");c.wiki(t),o.css("background-image","url(".concat(r,")")),u.wiki(a.current.text);var g=function(e){a.make(e),u.empty(),u.wiki(a.current.text),l.empty(),a.choices.forEach((function(e,t){$("<a>").addClass("dialogue-choice").wiki(e.text).on("click",(function(){return g(e.index)})).appendTo(l)}))};a.choices.forEach((function(e,t){$("<a>").addClass("dialogue-choice").wiki(e.text).on("click",(function(){return g(e.index)})).appendTo(l)})),a.isInStart&&a.visit(null,1),i.append(o,c,u,l).appendTo(this.output)}}),Macro.add(["reset_dialogue","reset_dlg"],{handler:function(){this.args.length<=0&&State.setVar("$dialogue_sessions",{});var e=State.getVar("$dialogue_sessions");e?this.args.forEach((function(t){e[t]&&delete e[t]})):State.setVar("$dialogue_sessions",{})}}),Macro.add("toggle_flag",{handler:function(){var e=getSession(getVarname(this.args));if(!e)return this.error("Dialogue: session not found");var t=this.args.slice(1),r=e.progress.state.flags;t.forEach((function(e){r.includes(e)?r.splice(r.indexOf(e),1):r.push(e)}))}}),Macro.add("push_flag",{handler:function(){var e=getSession(getVarname(this.args));if(!e)return this.error("Dialogue: session not found");var t=this.args.slice(1),r=e.progress.state.flags;t.forEach((function(e){r.includes(e)||r.push(e)}))}}),Macro.add("remove_flag",{handler:function(){var e=getSession(getVarname(this.args));if(!e)return this.error("Dialogue: session not found");var t=this.args.slice(1),r=e.progress.state.flags;t.forEach((function(e){r.includes(e)&&r.splice(r.indexOf(e),1)}))}}),Macro.add("set_tmp",{handler:function(){var e=getSession(getVarname(this.args));if(!e)return this.error("Dialogue: session not found");for(var t=this.args.slice(1),r=0;r<t.length;r+=2){var s=t[r],n=t[r+1];void 0!==n&&(e.progress.state.temporary[s]=n)}}}),Macro.add("set_var",{handler:function(){var e=getSession(getVarname(this.args));if(!e)return this.error("Dialogue: session not found");for(var t=this.args.slice(1),r=0;r<t.length;r+=2){var s=t[r],n=t[r+1];void 0!==n&&(e.progress.state.variables[s]=n)}}}),window.hasFlag=window.hasFlag||hasFlag,setup.hasFlag=hasFlag,window.getSVar=window.getSVar||getSVar,setup.getSVar=getSVar,window.setSVar=window.setSVar||setSVar,setup.setSVar=setSVar,window.getSTmp=window.getSTmp||getSTmp,setup.getSTmp=getSTmp,window.setSTmp=window.setSTmp||setSTmp,setup.setSTmp=setSTmp})()})()})();
/* End StoryTree */
/* twine-user-script #2: "index.js" */
setup.getPrice = function(basePrice) {
    if(hasFlag('_tree1','æ€åº¦æ•Œå¯¹')) {
        return basePrice * 3;
    } else if(hasFlag('_tree1','æ€åº¦å‹å¥½')) {
        return Math.floor(basePrice * 0.7);
    }
    return basePrice;
};

setup.canTrade = function(basePrice) {
    const finalPrice = setup.getPrice(basePrice);
    if(hasFlag && hasFlag('_tree1','æ€åº¦æ•Œå¯¹')) {
        return State.variables.caps >= finalPrice;
    }
    return !hasFlag('_tree1','æ€åº¦æ•Œå¯¹') || State.variables.caps >= finalPrice;
};



/*æˆå°±ç³»ç»Ÿ*/

if (window.setup === undefined) {
    window.setup = {};
}
window.setup.achievements = [];
window.setup.achievementDefinitions = [];
window.setup.globalAchievements = [];
window.defineAchievement = function(id, title, description, icon, category = "general", lockedDescription = "æœªè§£é”æ—¶çš„æç¤ºæè¿°") {
    let iconContent;
    if (icon.startsWith('http') || icon.startsWith('https')) {
        iconContent = `<img src="${icon}" class="achievement-icon-image" alt="${title}">`;
    } else if (icon.endsWith('.png') || icon.endsWith('.jpg') || icon.endsWith('.jpeg') || icon.endsWith('.gif')) {
        iconContent = `<img src="${icon}" class="achievement-icon-image" alt="${title}">`;
    } else {
        iconContent = icon;
    }
    window.setup.achievementDefinitions.push({
        id: id,
        title: title,
        description: description,
        lockedDescription: lockedDescription,
        icon: iconContent,
        category: category
    });
};
Macro.add('achievement', {
    handler: function() {
        var id = this.args[0];
        var achievement = window.setup.achievementDefinitions.find(a => a.id === id);
        
        if (!achievement) {
            return this.error(`Achievement with ID "${id}" not found`);
        }
        
        State.variables.achievements = State.variables.achievements || [];

        var isUnlockedInCurrentSave = State.variables.achievements.some(a => a.id === id);

        if (!isUnlockedInCurrentSave) {

            const newAchievement = {
                id: id,
                unlockTime: new Date().toISOString()
            };
            
            State.variables.achievements.push(newAchievement);
            window.setup.achievements = State.variables.achievements;
            
            // ç»™äºˆé•€é‡‘ç¥¨åˆ¸
            State.variables.goldTickets = (State.variables.goldTickets || 0) + 1;
            
            // æ±‡æŠ¥é•€é‡‘ç¥¨åˆ¸è·å¾—
            var ticketMsg = $('<div class="ticket-reward"><span class="ticket-icon">ğŸ«</span><p>è·å¾—é•€é‡‘ç¥¨åˆ¸ x1</p></div>');
            ticketMsg.appendTo('body');
            setTimeout(() => ticketMsg.fadeOut(() => ticketMsg.remove()), 2000);

            if (!window.setup.globalAchievements.some(a => a.id === id)) {
                window.setup.globalAchievements.push(newAchievement);
                localStorage.setItem('twine-global-achievements', JSON.stringify(window.setup.globalAchievements));
            }
            
            var $achievement = $("<div class='achievement'>" +
                "<div class='achievement-icon'>" + achievement.icon + "</div>" +
                "<div class='achievement-content'>" +
                    "<div class='achievement-title'>" + achievement.title + "</div>" +
                    "<div class='achievement-description'>" + achievement.description + "</div>" +
                "</div>" +
            "</div>");

            $achievement.appendTo('body');

            requestAnimationFrame(() => {
                $achievement.addClass('show');
            });

            setTimeout(() => {
                $achievement.removeClass('show');
                setTimeout(() => $achievement.remove(), 1000);
            }, 5000);
            
            updateAchievementsList();
        }
    }
});

Macro.add('achievementspopup', {
    handler: function() {
        var categories = [...new Set(window.setup.achievementDefinitions.map(a => a.category))];
        
        var categoryOptions = categories.map(c => `<option value='${c}'>${c}</option>`).join('');
        
        var dialogHTML = "<div id='achievements-fragment'>" +
            "<div class='achievements-filters'>" +
                "<select id='category-filter'>" +
                    "<option value='all'>å…¨éƒ¨åˆ†ç±»</option>" +
                    categoryOptions +
                "</select>" +
                "<select id='status-filter'>" +
                    "<option value='all'>å…¨éƒ¨çŠ¶æ€</option>" +
                    "<option value='unlocked'>å·²è§£é”</option>" +
                    "<option value='locked'>æœªè§£é”</option>" +
                "</select>" +
            "</div>" +
            "<div id='achievements-list'></div>" +
        "</div>";
        
        var $button = $("<button id='show-achievements'>æŸ¥çœ‹æˆå°±</button>");
        
        $button.on('click', () => {
            Dialog.setup("æˆå°±åˆ—è¡¨", "achievements");
            Dialog.append(dialogHTML);
            
            $('#category-filter, #status-filter').on('change', updateAchievementsList);
            
            updateAchievementsList();
            Dialog.open();
        });
        
        $button.appendTo(this.output);
    }
});

Macro.add('checkachievement', {
    handler: function() {
        var id = this.args[0];
        State.variables.hasAchievement = State.variables.achievements && 
                                       State.variables.achievements.some(a => a.id === id);
    }
});

window.checkAchievementCondition = function(id, condition) {
    if (condition && !State.variables.achievements.some(a => a.id === id)) {

        Engine.play(`<<achievement '${id}'>>`);
    }
};

function updateAchievementsList() {
    var $list = $('#achievements-list');
    if (!$list.length) return;

    var categoryFilter = $('#category-filter').val();
    var statusFilter = $('#status-filter').val();

    var scrollTop = $list.scrollTop();

    $list.css('min-height', $list.height());

    $list.empty();

    var fragment = document.createDocumentFragment();
    var itemCount = 0;

    window.setup.achievementDefinitions.forEach(achievement => {
        var isUnlockedInCurrentSave = State.variables.achievements.some(a => a.id === achievement.id);
        var isUnlockedGlobally = window.setup.globalAchievements.some(a => a.id === achievement.id);

        if (categoryFilter !== 'all' && achievement.category !== categoryFilter) return;
        if (statusFilter === 'unlocked' && !isUnlockedGlobally) return;
        if (statusFilter === 'locked' && isUnlockedGlobally) return;

        var title = isUnlockedGlobally ? achievement.title : "???";
        var description = isUnlockedGlobally ? 
            (isUnlockedInCurrentSave ? achievement.description : achievement.description + " (åœ¨å…¶ä»–å­˜æ¡£ä¸­è§£é”)") : 
            (achievement.lockedDescription || "æœªè§£é”çš„æˆå°±");
        var icon = isUnlockedGlobally ? achievement.icon : "â“";
        
        var className = isUnlockedGlobally ? 
            (isUnlockedInCurrentSave ? "unlocked-current" : "unlocked-other") : 
            "locked";

        var $achievementItem = $("<div>").addClass('achievement-item ' + className)
            .attr('data-index', itemCount++) 
            .append(
                $("<span>").addClass('achievement-icon').html(icon),
                $("<div>").addClass('achievement-info')
                    .append(
                        $("<span>").addClass('achievement-title').text(title),
                        $("<div>").addClass('achievement-description').text(description)
                    )
            );

        fragment.appendChild($achievementItem[0]);
    });

    $list.append(fragment);

    $list.scrollTop(scrollTop);

    setTimeout(() => {
        $('.achievement-item').addClass('show');
    }, 50);

    setTimeout(() => {
        $list.css('min-height', '');
    }, 300);

    if ($list.children().length === 0) {
        $list.append("<div class='no-achievements'>æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„æˆå°±</div>");
    }
}

function saveGlobalAchievements() {
    try {
        localStorage.setItem('twine-global-achievements', JSON.stringify(window.setup.globalAchievements));
    } catch (e) {
        console.error('Error saving global achievements:', e);
    }
}

// æ¯æ—¥ç¤¼ç‰©å®
Macro.add('dailygiftpopup', {
    handler: function() {
        var $button = $("<button id='show-daily-gift'>æ˜Ÿçµçš„ç¤¼ç‰©</button>");
        
        $button.on('click', () => {
            openDailyGiftDialog();
        });
        
        $button.appendTo(this.output);
    }
});

// æ‰“å¼€æ¯æ—¥ç¤¼ç‰©å¼¹çª—çš„å‡½æ•°
window.openDailyGiftDialog = function() {
    var now = new Date();
    var dayOfWeek = now.getDay();
    var today = now.toDateString();
    var weekDayName = setup.weekDayNames[dayOfWeek];
    
    // æ£€æŸ¥ä»Šå¤©æ˜¯å¦å·²ç»é¢†å–
    var alreadyClaimed = State.variables.dailyGiftLastClaimedDate === today;
    
    var dialogHTML = "<div id='daily-gift-content'>" +
        "<div class='daily-gift-info'>" +
            "<p><strong>ä»Šå¤©æ˜¯ï¼š</strong>" + weekDayName + "</p>" +
            "<p><strong>æ—¥æœŸï¼š</strong>" + now.toLocaleDateString('zh-CN') + "</p>" +
        "</div>";
    
    if (alreadyClaimed) {
        dialogHTML += "<div class='gift-status already-claimed'>" +
            "<p>âœ“ ä½ ä»Šå¤©å·²ç»é¢†å–è¿‡ç¤¼ç‰©äº†ï¼</p>" +
            "<p>æ˜å¤©å†æ¥å§~</p>" +
        "</div>";
    } else {
        var giftPool = setup.dailyGifts[dayOfWeek];
        var randomGift = giftPool[Math.floor(Math.random() * giftPool.length)];
        var itemName = setup.Item.get(randomGift.itemId).name;
        
        dialogHTML += "<div class='gift-status unclaimed'>" +
            "<p>ä»Šæ—¥" + weekDayName + "çš„ç¤¼ç‰©ï¼š</p>" +
            "<div class='gift-display'>" +
                "<span class='gift-icon'>ğŸ</span>" +
                "<p class='gift-item'><strong>" + itemName + " x" + randomGift.quantity + "</strong></p>" +
            "</div>" +
            "<button id='claim-daily-gift' data-item='" + randomGift.itemId + "' data-quantity='" + randomGift.quantity + "'>é¢†å–ç¤¼ç‰©</button>" +
        "</div>";
    }
    
    dialogHTML += "<div class='gift-pool-preview'>" +
        "<h4>" + weekDayName + "ç¤¼ç‰©æ± ï¼š</h4>" +
        "<ul>";
    
    setup.dailyGifts[dayOfWeek].forEach(gift => {
        var itemName = setup.Item.get(gift.itemId).name;
        dialogHTML += "<li>" + itemName + " x" + gift.quantity + "</li>";
    });
    
    dialogHTML += "</ul></div></div>";
    
    Dialog.setup("æ˜Ÿçµçš„ç¤¼ç‰©", "daily-gift");
    Dialog.append(dialogHTML);
    
    // ç»‘å®šé¢†å–æŒ‰é’®äº‹ä»¶
    setTimeout(() => {
        $('#claim-daily-gift').on('click', function() {
            var itemId = $(this).data('item');
            var quantity = $(this).data('quantity');
            var itemName = setup.Item.get(itemId).name;
            
            // æ·»åŠ ç‰©å“åˆ°ç©å®¶èƒŒåŒ…
            var inv = State.variables.player;
            inv.pickup(itemId, quantity);
            
            // è®°å½•é¢†å–æ—¥æœŸ
            State.variables.dailyGiftLastClaimedDate = today;
            
            // æ›´æ–°æ˜¾ç¤º
            $('.gift-status').removeClass('unclaimed').addClass('already-claimed');
            $('.gift-status').html(
                "<p>âœ“ æˆåŠŸé¢†å– " + itemName + " x" + quantity + "ï¼</p>" +
                "<p>å·²æ·»åŠ åˆ°ä½ çš„èƒŒåŒ…ä¸­</p>" +
                "<p>æ˜å¤©å†æ¥å§~</p>"
            );
            
            $('#claim-daily-gift').remove();
        });
    }, 0);
    
    Dialog.open();
};

function loadGlobalAchievements() {
    try {
        const savedGlobalAchievements = localStorage.getItem('twine-global-achievements');
        if (savedGlobalAchievements) {
            window.setup.globalAchievements = JSON.parse(savedGlobalAchievements);
        }
    } catch (e) {
        console.error('Error loading global achievements:', e);
        window.setup.globalAchievements = [];
    }
}

$(document).on(':passagestart', function() {
    try {

        loadGlobalAchievements();

        State.variables.achievements = State.variables.achievements || [];
        window.setup.achievements = State.variables.achievements;
    } catch (e) {
        console.error('Error loading achievements:', e);
    }
});

$(document).on(':passagesave', function() {
    try {
        localStorage.setItem('twine-achievements', JSON.stringify(State.variables.achievements));
        saveGlobalAchievements();
    } catch (e) {
        console.error('Error saving achievements:', e);
    }
});

$(document).on(':stateload', function() {
    try {

        loadGlobalAchievements();

        const currentSaveAchievements = State.variables.achievements || [];
        window.setup.achievements = currentSaveAchievements;

        updateAchievementsList();
    } catch (e) {
        console.error('Error loading achievements:', e);
    }
});

:: StoryStylesheet [stylesheet]
/* twine-user-stylesheet #1: "simple-inventory.css" */
/* Simple Inventory, for SugarCube 2, by Chapel
v3.0.1, 2024-07-22, 8c9749dbafa5f12948d743a8dedd4e1c74bb9e26 */
ul.simple-inventory-list{margin:0 auto;padding:0}.simple-inventory-listing{list-style:none;padding:.3rem .3rem .3rem 1rem;display:grid;grid-template-columns:1fr 1fr 1fr 1fr 1fr}.simple-inventory-listing>a,.simple-inventory-listing>span{display:inline-block}.all-listing.simple-inventory-listing{border-top:1px solid #fafafa;background-color:transparent}.drop-link{color:#e33}.drop-link:active,.drop-link:focus,.drop-link:hover{color:#f88}.consume-btn{color:#19AAD1;background-color:transparent;border:none;cursor:pointer;text-decoration:underline;padding:0;font-family:inherit;font-size:inherit}.consume-btn:active,.consume-btn:focus,.consume-btn:hover{color:#0d7a9e}.simple-inventory-filter{display:none !important;}.simple-inventory-filter input{display:none !important;}
/* End Simple Inventory */
/* twine-user-stylesheet #2: "Story Stylesheet" */
.shopping-interface p {
    display: grid;
    grid-template-columns: 2fr 1fr 1fr auto; /* åç§° / ä»·æ ¼ / ä½™é‡ / æ“ä½œ */
    align-items: center;
    gap: 0.5rem;
}

.shop-listing {
    padding: 0.5rem 0.75rem;
    border: 1px solid #444;
    border-radius: 6px;
    background-color: #1f1f1f;
}

.shop-listing .item-name {
    font-weight: 600;
}

.shop-listing .price strong {
    color: #fca303;
}

.shop-listing .actions a {
    display: inline-block;
    padding: 0.35rem 0.75rem;
    border: 2px solid #555;
    border-radius: 4px;
    color: #fff;
    background-color: #333;
    transition: all 0.2s;
}

.shop-listing .actions a:hover {
    background-color: #555;
    border-color: #777;
}

#inventory-search {
    margin-bottom: 0.5rem;
    text-align: center;
}

#inv-search-box {
    padding: 0.5rem;
    width: 60%;
    max-width: 300px;
    background-color: #222;
    color: #fff;
    border: 2px solid #555;
    font-size: 1rem;
}

#inv-search-box:focus {
    outline: none;
    border-color: rgba(252, 173, 3, 1);
}

#inventory-categories {
    margin-bottom: 1rem;
    display: flex;
    justify-content: center;
    gap: 0.5rem;
    flex-wrap: nowrap;
}

.category-btn {
    padding: 0.5rem 1rem;
    margin-right: 0; /* ä½¿ç”¨å®¹å™¨ gap æ§åˆ¶é—´è· */
    background-color: #333;
    color: #fff;
    border: 2px solid #555;
    cursor: pointer;
    transition: all 0.2s;
}

.category-btn:hover {
    background-color: #555;
}

.category-btn.active {
    background-color: #0f0;
    color: #000;
    border-color: #0f0;
    font-weight: bold;
}

.simple-inventory-listing.cat-hidden {
    display: none;
}

/* å°å±å¹•è‡ªé€‚åº”ï¼šæŒ‰é’®åœ¨çª„å±è‡ªåŠ¨æ¢è¡Œ */
@media (max-width: 600px) {
    #inventory-categories {
        flex-wrap: wrap;
        row-gap: 0.5rem;
    }
    .category-btn {
        flex: 0 0 auto;
    }
}
/*Inventory ends here*/



/*ä¾§è¾¹æ è¿›åº¦æ¡ */
.state-progress {
  position: relative;
  height: 100%;
  border-radius: 2px;
}

.state-bar {
    position: relative;
    cursor: pointer;
    width: 232px;
    height: 12px;  /* åŠ ç²—è¿›åº¦æ¡ç”¨ */
    /* å¤–è¾¹æ¡† */
    border: 1px solid #6b5fa7;
    border-radius: 4px;
    /* å†…è¾¹è·è®©è¿›åº¦æ¡ä¸è´´è¾¹ */
    padding: 1px;
    box-sizing: border-box;
    background: #1c1a24;
}

.state-tooltip {
    display: none;
    position: absolute;
    background: rgba(0, 0, 0, 0.85);
    color: #fff;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 14px;
    white-space: nowrap;
    pointer-events: none;
    z-index: 1000;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
}
/* twine-user-stylesheet #1: "storytree.css" */
/* StoryTree Styles, Ver.0.1.9 */
/* Build Date: 2025-01-24T20:25:19.582Z */
.story-dialogue{background:rgba(40,40,40,.95);border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,.3);display:grid;gap:10px;grid-template-areas:"avatar name" "avatar content" "choices choices";grid-template-columns:80px 1fr;margin:20px auto;max-width:600px;padding:15px;position:relative}.story-dialogue .avatar{background-color:#e0e0e0;background-position:50%;background-size:cover;border-radius:4px;grid-area:avatar;height:60px;width:60px}.story-dialogue .name{color:#fff;font-size:1.1em;font-weight:700;grid-area:name;padding:5px 0}.story-dialogue .content{color:#e0e0e0;grid-area:content;line-height:1.5;margin-bottom:15px}.story-dialogue .choices{border-top:1px solid #444;display:flex;flex-direction:column;gap:8px;grid-area:choices;padding-top:10px}.story-dialogue .choices a{background:#444;border-radius:4px;color:#fff;padding:8px 15px;text-decoration:none;transition:background .2s}.story-dialogue .choices a:hover{background:#666;cursor:pointer}
/* End StoryTree Styles */
/* twine-user-stylesheet #2: "index.css" */
.warning-box {
    background: rgba(220, 53, 69, 0.1);
    border-left: 4px solid #dc3545;
    border-radius: 4px;
    padding: 1.5rem;
    margin: 1rem 0;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.warning-title {
    color: #dc3545;
    font-size: 1.25rem;
    font-weight: bold;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.warning-content {
    color: #666;
    line-height: 1.6;
}

.warning-content p {
    margin: 0.5rem 0;
}


/* æˆå°±ç³»ç»Ÿ */
.zoom-in {
  display: inline-block;       
  animation: zoomInEffect 0.6s ease forwards;
  opacity: 0;                   
}

@keyframes zoomInEffect {
  0% {
    transform: scale(0.5);      /* åŠ¨ç”»å¼€å§‹æ—¶ç¼©å° */
    opacity: 0;                 /* åˆå§‹æ—¶é€æ˜ */
  }
  50% {
    transform: scale(1.2);      /* ä¸­é—´é˜¶æ®µç¨å¾®æ”¾å¤§ */
    opacity: 1;                 /* å˜ä¸ºå®Œå…¨ä¸é€æ˜ */
  }
  100% {
    transform: scale(1);        /* æœ€ç»ˆæ¢å¤åˆ°æ­£å¸¸å¤§å° */
    opacity: 1;                 /* ä¿æŒå®Œå…¨ä¸é€æ˜ */
  }
}

:root {
    --glass-strong: rgba(255, 255, 255, 0.12);
    --glass-medium: rgba(255, 255, 255, 0.08);
    --glass-light: rgba(255, 255, 255, 0.06);
    --bg-modal: rgba(23, 25, 35, 0.95);  
    --bg-dropdown: rgba(28, 30, 40, 0.95);
    --bg-dropdown-hover: rgba(45, 50, 65, 0.98);
    --bg-card: rgba(28, 30, 40, 0.95);
    --text-primary: rgba(255, 255, 255, 0.95);
    --text-secondary: rgba(255, 255, 255, 0.7);
    --text-tertiary: rgba(255, 255, 255, 0.5);
    --text-disabled: rgba(255, 255, 255, 0.35);
    --border-light: rgba(255, 255, 255, 0.08);
    --border-medium: rgba(255, 255, 255, 0.12);
    --glow-primary: rgba(255, 255, 255, 0.15);
    --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.1);
    --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.12);
    --shadow-lg: 0 8px 16px rgba(0, 0, 0, 0.14);
}

@keyframes fadeScale {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes achievementSlideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

#show-achievements {
    position: relative;
    padding: 0.875rem 1.75rem;
    background: var(--glass-light);
    color: var(--text-primary);
    border: 1px solid var(--border-light);
    border-radius: 8px;
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: transform 0.2s ease, background-color 0.2s ease;
    will-change: transform;  
}

#show-achievements:hover {
    background: var(--glass-medium);
    transform: translateY(-2px);
}

.achievements-popup {
    display: none;
    position: fixed;
    inset: 0;
    margin: auto;
    z-index: 999;
    width: 85%;
    max-width: 500px;
    height: fit-content;
    max-height: 70vh;
    background: var(--bg-modal);
    border: 1px solid var(--border-light);
    animation: fadeScale 0.2s ease forwards;
    border-radius: 12px;
    padding: 1rem;
    box-shadow: var(--shadow-lg);
    will-change: transform, opacity;  
}

.achievements-content {
    background: var(--bg-card);
    margin: 0;
    padding: 1.25rem;
    width: 100%;
    height: 100%;
    max-height: calc(70vh - 2rem);
    border-radius: 8px;
    border: 1px solid var(--border-light);
    position: relative;
    overflow-y: auto;
    overscroll-behavior: contain;  
}


.achievements-content h3 {
    color: var(--text-primary);
    font-size: 1.125rem;
    font-weight: 600;
    text-align: center;
    margin-bottom: 1.25rem;
    letter-spacing: -0.02em;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--border-light);
}

.achievements-filters {
    display: flex;
    gap: 1rem;
    margin-bottom: 1.5rem;
    padding: 0.75rem;
    background: var(--glass-light);
    border-radius: 8px;
    border: 1px solid var(--border-light);
}

.achievements-filters select {
    flex: 1;
    padding: 0.75rem 2rem 0.75rem 0.75rem;
    background: var(--bg-dropdown);
    color: var(--text-primary);
    border: 1px solid var(--border-light);
    border-radius: 6px;
    font-size: 0.9375rem;
    cursor: pointer;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='none' viewBox='0 0 24 24' stroke='rgba(255,255,255,0.7)'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 0.75rem center;
    background-size: 1rem;
    transition: background-color 0.2s ease;
}

.achievements-filters select:hover {
    background-color: var(--bg-dropdown-hover);
}

.achievement-item {
    position: relative;
    display: flex;
    align-items: center;
    gap: 0.875rem;
    padding: 0.875rem;
    margin-bottom: 0.625rem;
    background: var(--glass-light);
    border: 1px solid var(--border-light);
    border-radius: 8px;
    transition: transform 0.2s ease;
    will-change: transform, opacity;
    opacity: 0;
    transform: translateY(10px);
}

.modal-backdrop {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: var(--bg-modal);
    z-index: 998;
    opacity: 0;
    transition: opacity 0.2s ease;
    display: none;
}

.achievement-item.show {
    opacity: 1;
    transform: translateY(0);
}

.achievement-item.unlocked-current {
    background: var(--glass-medium);
}

.achievement-item.unlocked-other {
    opacity: 0.8;
}

.achievement-item.locked {
    opacity: 0.7;
}

.achievement-icon {
    flex-shrink: 0;
    width: 2.5rem;
    height: 2.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
    color: var(--text-primary);
    background: var(--glass-medium);
    border-radius: 6px;
}

.achievement-icon-image {
    width: 100%;
    height: 100%;
    object-fit: contain;
    border-radius: 6px;
}

.achievement-title {
    color: var(--text-primary);
    font-weight: 600;
    font-size: 0.9375rem;
    margin-bottom: 0.25rem;
}

.achievement-description {
    color: var(--text-secondary);
    font-size: 0.875rem;
    line-height: 1.4;
}

#close-achievements {
    position: absolute;
    right: 1rem;
    top: 1rem;
    width: 2.25rem;
    height: 2.25rem;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-secondary);
    background: var(--glass-light);
    border: 1px solid var(--border-light);
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s ease;
    z-index: 1000;
}

#close-achievements:hover {
    color: var(--text-primary);
    background: var(--glass-medium);
}

.achievement {
    position: fixed;
    top: 1rem;
    right: 1rem;
    width: 280px;
    background: var(--bg-card);
    color: var(--text-primary);
    padding: 1rem;
    border-radius: 8px;
    border: 1px solid var(--border-light);
    box-shadow: var(--shadow-lg);
    display: flex;
    align-items: center;
    gap: 0.875rem;
    z-index: 999;
    transform: translateX(100%);
    opacity: 0;
    will-change: transform, opacity;
}

.achievement.show {
    animation: achievementSlideIn 0.3s ease forwards;
}

@media (max-width: 768px) {
    .achievements-popup {
        width: 90%;
        max-height: 80vh;
        padding: 0.75rem;
    }
    
    .achievements-filters {
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .achievement {
        width: calc(100% - 2rem);
        right: 1rem;
    }
}

.achievements-content {
    -webkit-overflow-scrolling: touch;  
    scroll-behavior: smooth;
}

.achievements-popup,
.achievement-item,
.achievement {
    transform: translateZ(0);
    backface-visibility: hidden;
}


/*å¼¹çª—å¤štab */
#ui-dialog-titlebar {   /*å¼¹çª—æ ‡é¢˜*/
	background-color: #000;  /*æ ‡é¢˜çš„èƒŒæ™¯é¢œè‰²*/
	min-height: 24px;  /*æœ€å°é«˜åº¦*/
	position: relative;  /*ç›¸å¯¹å®šä½*/
    height: 52px;
}

#ui-dialog-title {
	font-size: 1.5em;  /* æ ‡é¢˜çš„å­—ä½“å¤§å°ä¸º1.5emï¼ˆç›¸å¯¹äºçˆ¶å…ƒç´ çš„å­—ä½“å¤§å°ï¼‰ */
	margin: 0;  /* æ ‡é¢˜çš„å¤–è¾¹è·ä¸º0 */
	padding: 0.2em 3.5em 0.2em 0.5em;  /* æ ‡é¢˜çš„å†…è¾¹è·ï¼Œä¸Šä¸‹ä¸º0.2emï¼Œå·¦å³åˆ†åˆ«ä¸º3.5emå’Œ0.5em */
	text-align: center;  /* æ ‡é¢˜æ–‡å­—å±…ä¸­å¯¹é½ */
	text-transform: uppercase;  /* å°†æ ‡é¢˜æ–‡å­—è½¬æ¢ä¸ºå¤§å†™å­—æ¯ */
  
}

.title-buttons {
    display: flex;
    color:#fff;
    gap: 10px; /* æŒ‰é’®ä¹‹é—´çš„é—´è· */
    height: 100%; 
}

.popup-button {
    background-color: #000; 
    padding: 5px 10px;
    cursor: pointer;
    color: #ffffff;
    text-align: center;
    height: 3rem;
    font-size: 15px;
    border: transparent;
    border-bottom: 1px solid #444;
    /*background-color: black;*/
}

.popup-button:hover {
  border-bottom: 1px solid #444;
    
}

.popup-button:not(.active) {
   
}

.popup-button.active {
  background-color: rgba(169, 169, 169, 0.3);
  border-radius: 20px 20px 0 0;
}