:: æˆ˜æ–—å¼€å§‹ [nobr]  {"position":"200,200"}
<<if not $playerHeroes or $playerHeroes.length === 0>>
    <<set $playerHeroes to ["Master_Yi"]>>
<</if>>

<<if not $heroStates>>
    <<set $heroStates to {
        Master_Yi: { hp: 50, maxHp: 50, level: 1 }
    }>>
<</if>>

/* åˆå§‹åŒ–æˆ˜æ–— */
<<set $battle to {
    heroes: [],
    monsters: [],
    battleList: [],
    currentTurn: 0,
    teamShield: 0,
    selectedTarget: null
}>>

/* ä»æ¨¡æ¿åˆ›å»ºè‹±é›„å®ä¾‹ï¼Œä½¿ç”¨$heroStatesä¸­ä¿å­˜çš„å½“å‰è¡€é‡ */
<<for _heroId range $playerHeroes>>
    <<set _template to setup.Heroes[_heroId]>>
    <<if _template>>
        <<set _heroState to $heroStates[_heroId]>>
        <<set _hero to {
            id: _template.id,
            name: _template.name,
            hp: _heroState ? _heroState.hp : _template.maxHp,
            maxHp: _heroState ? _heroState.maxHp : _template.maxHp,
            level: _heroState ? _heroState.level : _template.level,
            attack: _template.attack,
            defense: _template.defense,
            speed: _template.speed,
            diceSet: clone(_template.diceSet),
            type: "hero",
            damageReduction: 0,
            perfectBlock: false
        }>>
        <<run $battle.heroes.push(_hero)>>
    <</if>>
<</for>>

/* ä»æ€ªç‰©åˆ—è¡¨åˆ›å»ºæ€ªç‰©å®ä¾‹ */
<<if $encounterMonsters>>
    <<for _monsterId range $encounterMonsters>>
        <<set _template to setup.Enemies[_monsterId]>>
        <<if _template>>
            <<set _monster to {
                id: _template.id,
                name: _template.name,
                hp: _template.maxHp,
                maxHp: _template.maxHp,
                attack: _template.attack,
                defense: _template.defense,
                special: _template.special,
                speed: _template.speed,
                type: "monster"
            }>>
            <<run $battle.monsters.push(_monster)>>
        <</if>>
    <</for>>
<<else>>
    /* é»˜è®¤é­é‡2åªå²è±å§† */
    <<for _i to 0; _i < 2; _i++>>
        <<set _template to setup.Enemies.slime>>
        <<set _monster to {
            id: _template.id + "_" + _i,
            name: _template.name + (_i + 1),
            hp: _template.maxHp,
            maxHp: _template.maxHp,
            attack: _template.attack,
            defense: _template.defense,
            special: _template.special,
            speed: _template.speed,
            type: "monster"
        }>>
        <<run $battle.monsters.push(_monster)>>
    <</for>>
<</if>>

/* åˆ›å»ºæˆ˜æ–—åˆ—è¡¨ï¼ˆæŒ‰é€Ÿåº¦æ’åºï¼‰ */
<<set _allUnits to $battle.heroes.concat($battle.monsters)>>
<<set $battle.battleList to _allUnits.sort(function(a, b) {
    return b.speed - a.speed;
})>>

<div class="battle-start-screen">
    <h2>æˆ˜æ–—å¼€å§‹ï¼</h2>
    <div class="energy-display">ä½“åŠ›: $states.energy.value/$states.energy.max</div>
    
    <div class="battle-preview">
        <h3>ä½ çš„é˜Ÿä¼ï¼š</h3>
        <<for _hero range $battle.heroes>>
            <div class="preview-hero">
                _hero.name (ç­‰çº§_hero.level) - HP: _hero.hp/_hero.maxHp
            </div>
        <</for>>
        
        <h3>é­é‡çš„æ•Œäººï¼š</h3>
        <<for _monster range $battle.monsters>>
            <div class="preview-enemy">
                _monster.name - HP: _monster.hp/_monster.maxHp
            </div>
        <</for>>
    </div>
    
    <<link "å¼€å§‹æˆ˜æ–—" "æˆ˜æ–—å›åˆ">><</link>>
</div>


:: æˆ˜æ–—å›åˆ [nobr] {"position":"400,200"}
/* æ£€æŸ¥èƒœè´Ÿæ¡ä»¶ */
<<set _allMonstersDefeated to $battle.monsters.every(function(m) { return m.hp <= 0; })>>
<<set _allHeroesDefeated to $battle.heroes.every(function(h) { return h.hp <= 0; })>>

<<if _allMonstersDefeated>>
    <<goto "æˆ˜æ–—èƒœåˆ©">>
<<elseif _allHeroesDefeated>>
    <<goto "æˆ˜æ–—å¤±è´¥">>
<</if>>

/* è·å–å½“å‰è¡ŒåŠ¨å•ä½ */
<<set _currentUnit to $battle.battleList[$battle.currentTurn]>>

/* è·³è¿‡å·²æ­»äº¡å•ä½ */
<<if _currentUnit.hp <= 0>>
    <<set $battle.currentTurn to ($battle.currentTurn + 1) % $battle.battleList.length>>
    <<goto "æˆ˜æ–—å›åˆ">>
<</if>>

/* å¦‚æœæ˜¯æ€ªç‰©è¡ŒåŠ¨ */
<<if _currentUnit.type === "monster">>
    <<goto "æ€ªç‰©å›åˆ">>
<</if>>

/* è‹±é›„è¡ŒåŠ¨ - æ˜¾ç¤ºæˆ˜åœº */
<h3>è½®åˆ° _currentUnit.name è¡ŒåŠ¨</h3>
<div class="energy-display">ä½“åŠ›: $states.energy.value/$states.energy.max</div>

<!-- å‡ºæ‹›é¡ºåº -->
<div class="turn-order">
    <strong>å‡ºæ‹›é¡ºåºï¼š</strong>
    <<for _i, _unit range $battle.battleList>>
        <<if _unit.hp > 0>>
            <<if _i === $battle.currentTurn>>
                <span class="current-turn-unit">ã€<<= _unit.name>>ã€‘</span>
            <<else>>
                <span class="turn-unit"><<= _unit.name>></span>
            <</if>>
            <<if _i < $battle.battleList.length - 1>> â†’ <</if>>
        <</if>>
    <</for>>
</div>

<!-- æ•Œäººä¿¡æ¯ï¼ˆä¸Šæ–¹ï¼‰ -->
<div class="battle-container">
<<for _index, _monster range $battle.monsters>>
  <<if _monster.hp > 0>>
    <div class="enemy-card">
        æ•Œäºº<<= _index+1 >>: <<= _monster.name>> <br>
        è¡€é‡: <<= _monster.hp>>/<<= _monster.maxHp>><br>
        æ”»å‡»: <<= _monster.attack>><br>
        é€Ÿåº¦: <<= _monster.speed>>
    </div>
  <</if>>
<</for>>
</div>

<!-- é˜Ÿä¼ä¿¡æ¯ï¼ˆä¸‹æ–¹ï¼‰ -->
<div class="player-info">
    <<for _hero range $battle.heroes>>
        <div>
            <<= _hero.name>> - ç­‰çº§: <<= _hero.level>> | HP: <<= _hero.hp>>/<<= _hero.maxHp>> | æ”»å‡»: <<= _hero.attack>>
            <<if _hero.id === _currentUnit.id>>
                <strong style="color: #4CAF50;">ï¼ˆå½“å‰å›åˆï¼‰</strong>
            <</if>>
        </div>
    <</for>>
    <<if $battle.teamShield > 0>>
        <div>ğŸ›¡ï¸ é˜Ÿä¼æŠ¤ç›¾: $battle.teamShield</div>
    <</if>>
</div>

<<link "æŠ•æ·éª°å­" "æŠ•æ·éª°å­">><</link>>


:: æŠ•æ·éª°å­ [nobr] {"position":"600,200"}
<<set _currentUnit to $battle.battleList[$battle.currentTurn]>>
<<set $diceResults to []>>
<<set $battle.selectedDice to []>>
<<set $battle.selectedTarget to null>>

/* ä¸ºå½“å‰è‹±é›„çš„éª°å­ç»„æŠ•æ· */
<<for _dieIndex to 0; _dieIndex < _currentUnit.diceSet.length; _dieIndex++>>
    <<set _die to _currentUnit.diceSet[_dieIndex]>>
    <<set _rollResult to random(0, _die.faces - 1)>>
    <<set _faceValue to _die.content[_rollResult]>>
    <<run $diceResults.push({
        dieIndex: _dieIndex,
        face: _rollResult + 1,
        value: _faceValue,
        effect: setup.DiceEffects[_faceValue],
        selected: false
    })>>
<</for>>

<h3>_currentUnit.name æŠ•æ·äº† $diceResults.length ä¸ªéª°å­</h3>

<div class="dice-results-summary">
    <h4>æŠ•æ·ç»“æœï¼š</h4>
    <<for _index, _result range $diceResults>>
        <div class="result-item">
            éª°å­ <<= _index + 1>>: <<= _result.effect.name>>
            <<if _result.value !== 'empty'>>
                <<if _result.effect.damage>>(ä¼¤å®³+<<= _result.effect.damage>>)<</if>>
                <<if _result.effect.heal>>(æ²»ç–—<<= _result.effect.heal>>)<</if>>
                <<if _result.effect.teamShield>>(æŠ¤ç›¾+<<= _result.effect.teamShield>>)<</if>>
                <<if _result.effect.perfectBlock>>(å®Œç¾æ ¼æŒ¡)<</if>>
                <<if _result.effect.damageReduction>>(å‡ä¼¤<<= Math.floor(_result.effect.damageReduction * 100)>>%)<</if>>
            <</if>>
        </div>
    <</for>>
</div>

<<link "é€‰æ‹©è¡ŒåŠ¨" "é€‰æ‹©éª°å­è¡ŒåŠ¨">><</link>>


:: é€‰æ‹©éª°å­è¡ŒåŠ¨ [nobr] {"position":"700,200"}
<<set _currentUnit to $battle.battleList[$battle.currentTurn]>>

<!-- æ•Œäººä¿¡æ¯ï¼ˆä¸Šæ–¹ï¼‰ -->
<div class="battle-container">
<<for _index, _monster range $battle.monsters>>
  <<if _monster.hp > 0>>
    <div class="enemy-card">
        æ•Œäºº<<= _index+1 >>: <<= _monster.name>> <br>
        è¡€é‡: <<= _monster.hp>>/<<= _monster.maxHp>><br>
        æ”»å‡»: <<= _monster.attack>><br>
        é€Ÿåº¦: <<= _monster.speed>>
    </div>
  <</if>>
<</for>>
</div>

<!-- é˜Ÿä¼ä¿¡æ¯ -->
<div class="player-info">
    <<set _currentHero to $battle.heroes.find(function(h) { return h.id === _currentUnit.id; })>>
    <<if _currentHero>>
        å½“å‰è¡ŒåŠ¨: <<= _currentHero.name>><br>
        HP: <<= _currentHero.hp>>/<<= _currentHero.maxHp>><br>
        æ”»å‡»åŠ›: <<= _currentHero.attack>>
    <<else>>
        å½“å‰è¡ŒåŠ¨: <<= _currentUnit.name>><br>
        HP: <<= _currentUnit.hp>>/<<= _currentUnit.maxHp>><br>
        æ”»å‡»åŠ›: <<= _currentUnit.attack>>
    <</if>>
</div>

<!-- é€‰æ‹©è¦ä½¿ç”¨çš„éª°å­ -->
<div class="action-section">
    <div class="action-group">
        <div class="action-title">é€‰æ‹©è¦ä½¿ç”¨çš„éª°å­æ•ˆæœï¼š</div>
        <div class="action-links">
        <<for _index, _result range $diceResults>>
            <<if _result.value !== 'empty'>>
                <<capture _index, _result>>
                    <label>
                        <<checkbox "_result.selected" false true autocheck>>
                        éª°å­<<= _index + 1>>ï¼š<<= _result.effect.name>>
                    </label>
                    <<if _index !== $diceResults.length - 1>> | <</if>>
                <</capture>>
            <</if>>
        <</for>>
        </div>
    </div>

    <!-- é€‰æ‹©æ”»å‡»ç›®æ ‡ -->
    <<set _hasAttack to $diceResults.some(function(r) { return r.effect && r.effect.damage; })>>
    <<if _hasAttack>>
        <div class="action-group">
            <div class="action-title">é€‰æ‹©æ”»å‡»ç›®æ ‡ï¼š</div>
            <div class="action-links">
            <<for _index, _monster range $battle.monsters>>
                <<if _monster.hp > 0>>
                    <<capture _index>>
                        <label>
                            <<radiobutton "$battle.selectedTarget" _index autocheck>>
                            æ•Œäºº<<= _index + 1>>ï¼ˆ<<= _monster.name>>ï¼‰
                        </label>
                        <<if _index !== $battle.monsters.length - 1>> | <</if>>
                    <</capture>>
                <</if>>
            <</for>>
            </div>
        </div>
    <</if>>
</div>

<<link "æ‰§è¡Œè¡ŒåŠ¨" "æ‰§è¡Œè¡ŒåŠ¨">><</link>>
<<link "è·³è¿‡å›åˆ" "æ€ªç‰©å›åˆ">><</link>>


:: æ‰§è¡Œè¡ŒåŠ¨ [nobr] {"position":"800,200"}
<<set _currentUnit to $battle.battleList[$battle.currentTurn]>>
<<set $battleMessage to "">>

/* æ‰¾åˆ°$battle.heroesä¸­çš„çœŸå®è‹±é›„å¯¹è±¡ */
<<set _realHero to $battle.heroes.find(function(h) { return h.id === _currentUnit.id; })>>
<<if not _realHero>>
    <<set _realHero to _currentUnit>>
<</if>>

/* å¤„ç†æ‰€æœ‰é€‰ä¸­çš„éª°å­ç»“æœ */
<<set _totalDamage to 0>>
<<set _totalHeal to 0>>
<<set _needsTarget to false>>

<<for _result range $diceResults>>
    <<if _result.selected and _result.effect>>
        <<set _effect to _result.effect>>
        
        /* æ”»å‡»æ•ˆæœ */
        <<if _effect.damage>>
            <<set _totalDamage += _effect.damage + _realHero.attack>>
            <<set _needsTarget to true>>
        <</if>>
        
        /* æ²»ç–—æ•ˆæœ */
        <<if _effect.heal>>
            <<set _totalHeal += _effect.heal>>
        <</if>>
        
        /* é˜²å¾¡æ•ˆæœ */
        <<if _effect.teamShield>>
            <<set $battle.teamShield += _effect.teamShield>>
            <<set $battleMessage += _realHero.name + " æå‡äº†é˜Ÿä¼æŠ¤ç›¾ï¼(+" + _effect.teamShield + ")\n">>
        <</if>>
        
        /* å®Œç¾æ ¼æŒ¡ */
        <<if _effect.perfectBlock>>
            <<set _realHero.perfectBlock to true>>
            <<set $battleMessage += _realHero.name + " è¿›å…¥äº†å®Œç¾æ ¼æŒ¡çŠ¶æ€ï¼\n">>
        <</if>>
        
        /* ä¼¤å®³å‡å… */
        <<if _effect.damageReduction>>
            <<set _realHero.damageReduction to _effect.damageReduction>>
            <<set $battleMessage += _realHero.name + " è·å¾—äº†ä¼¤å®³å‡å…ï¼(å‡å… " + Math.floor(_effect.damageReduction * 100) + "%)\n">>
        <</if>>
    <</if>>
<</for>>

/* åº”ç”¨æ²»ç–— */
<<if _totalHeal > 0>>
    <<set _oldHp to _realHero.hp>>
    <<set _realHero.hp to Math.min(_realHero.hp + _totalHeal, _realHero.maxHp)>>
    <<set $battleMessage += _realHero.name + " æ¢å¤äº† " + (_realHero.hp - _oldHp) + " ç‚¹ç”Ÿå‘½å€¼ï¼\n">>
<</if>>

/* åº”ç”¨ä¼¤å®³ */
<<if _needsTarget and $battle.selectedTarget !== null>>
    <<set _target to $battle.monsters[$battle.selectedTarget]>>
    <<set _target.hp -= _totalDamage>>
    <<if _target.hp < 0>>
        <<set _target.hp to 0>>
    <</if>>
    <<set $battleMessage += _realHero.name + " å¯¹ " + _target.name + " é€ æˆäº† " + _totalDamage + " ç‚¹ä¼¤å®³ï¼\n">>
    
    <<if _target.hp <= 0>>
        <<set $battleMessage += _target.name + " è¢«å‡»è´¥äº†ï¼\n">>
    <</if>>
<</if>>

<div class="action-result">
    <h3>è¡ŒåŠ¨ç»“æœ</h3>
    
    <<if $battleMessage !== "">>
        <div class="battle-log">
            <<= $battleMessage.replace(/\n/g, '<br>')>>
        </div>
    <<else>>
        <p>ä½ ä»€ä¹ˆéƒ½æ²¡åšï¼</p>
    <</if>>
    
    <<link "ç»§ç»­" "æ€ªç‰©å›åˆ">><</link>>
</div>


:: æ€ªç‰©å›åˆ [nobr] {"position":"400,400"}
/* æ£€æŸ¥æ˜¯å¦æ‰€æœ‰æ€ªç‰©éƒ½å·²è¢«å‡»è´¥ */
<<set _allMonstersDefeated to $battle.monsters.every(function(m) { return m.hp <= 0; })>>
<<if _allMonstersDefeated>>
    <<goto "æˆ˜æ–—èƒœåˆ©">>
<</if>>

<div class="monster-turn">
    <h3>æ€ªç‰©å›åˆ</h3>
    
    <<set $battleMessage to "">>
    
    /* æ‰€æœ‰å­˜æ´»çš„æ€ªç‰©ä¾æ¬¡è¡ŒåŠ¨ */
    <<for _monster range $battle.monsters>>
        <<if _monster.hp > 0>>
            /* éšæœºé€‰æ‹©ä¸€ä¸ªå­˜æ´»çš„è‹±é›„æ”»å‡» */
            <<set _targets to []>>
            <<for _hero range $battle.heroes>>
                <<if _hero.hp > 0>>
                    <<set _targets.push(_hero)>>
                <</if>>
            <</for>>
            
            <<if _targets.length > 0>>
                <<set _targetIndex to Math.floor(Math.random() * _targets.length)>>
                <<set _target to _targets[_targetIndex]>>
                
                /* è®¡ç®—ä¼¤å®³ */
                <<set _baseDamage to _monster.attack>>
                <<set _finalDamage to _baseDamage>>
                
                /* æŠ¤ç›¾å‡å… */
                <<if $battle.teamShield > 0>>
                    <<set _shieldAbsorb to Math.min($battle.teamShield, _finalDamage)>>
                    <<set $battle.teamShield -= _shieldAbsorb>>
                    <<set _finalDamage -= _shieldAbsorb>>
                    <<set $battleMessage += "é˜Ÿä¼æŠ¤ç›¾å¸æ”¶äº† " + _shieldAbsorb + " ç‚¹ä¼¤å®³ï¼\n">>
                <</if>>
                
                /* å®Œç¾æ ¼æŒ¡ */
                <<if _target.perfectBlock>>
                    <<set $battleMessage += _target.name + " çš„å®Œç¾æ ¼æŒ¡ç”Ÿæ•ˆï¼\n">>
                    <<set _finalDamage to 0>>
                    <<set _target.perfectBlock to false>>
                <<else>>
                    /* ä¼¤å®³å‡å… */
                    <<if _target.damageReduction>>
                        <<set _reduction to Math.floor(_finalDamage * _target.damageReduction)>>
                        <<set _finalDamage -= _reduction>>
                        <<set $battleMessage += _target.name + " çš„ä¼¤å®³å‡å…ç”Ÿæ•ˆï¼(å‡å°‘ " + _reduction + " ç‚¹ä¼¤å®³)\n">>
                        <<set _target.damageReduction to 0>>
                    <</if>>
                <</if>>
                
                /* åº”ç”¨ä¼¤å®³ */
                <<if _finalDamage > 0>>
                    <<set _target.hp -= _finalDamage>>
                    <<if _target.hp < 0>>
                        <<set _target.hp to 0>>
                    <</if>>
                    <<set $battleMessage += _monster.name + " æ”»å‡»äº† " + _target.name + "ï¼Œé€ æˆäº† " + _finalDamage + " ç‚¹ä¼¤å®³ï¼\n">>
                    
                    <<if _target.hp <= 0>>
                        <<set $battleMessage += _target.name + " è¢«å‡»è´¥äº†ï¼\n">>
                    <</if>>
                <</if>>
            <</if>>
        <</if>>
    <</for>>
    
    <div class="battle-log">
        <<= $battleMessage.replace(/\n/g, '<br>')>>
    </div>
    
    <<link "ä¸‹ä¸€å›åˆ" "ä¸‹ä¸€å›åˆ">><</link>>
</div>


:: ä¸‹ä¸€å›åˆ [nobr] {"position":"600,400"}
/* è·³è¿‡æ‰€æœ‰æ€ªç‰©å›åˆï¼Œæ‰¾åˆ°ä¸‹ä¸€ä¸ªè‹±é›„æˆ–å›åˆ°å¼€å§‹ */
<<set $battle.currentTurn to ($battle.currentTurn + 1) % $battle.battleList.length>>

/* è·³è¿‡å‰©ä½™çš„æ€ªç‰©å›åˆ */
<<set _skipped to 0>>
<<set _maxSkip to $battle.battleList.length>>
<<for _i to 0; _i < _maxSkip; _i++>>
    <<set _currentUnit to $battle.battleList[$battle.currentTurn]>>
    <<if _currentUnit.type === "monster">>
        <<set $battle.currentTurn to ($battle.currentTurn + 1) % $battle.battleList.length>>
        <<set _skipped++>>
    <<else>>
        <<break>>
    <</if>>
<</for>>

/* å¦‚æœå›åˆ°ç¬¬ä¸€ä¸ªå•ä½æˆ–è·³è¿‡äº†æ‰€æœ‰å•ä½ï¼Œè¡¨ç¤ºæ–°çš„ä¸€è½® */
<<if $battle.currentTurn === 0 or _skipped >= $battle.battleList.length>>
    <<set $battle.teamShield to Math.max(0, $battle.teamShield - 1)>>
<</if>>

<<goto "æˆ˜æ–—å›åˆ">>


:: æˆ˜æ–—èƒœåˆ© [nobr] {"position":"800,600"}
/* ä¿å­˜è‹±é›„å½“å‰è¡€é‡ */
<<for _hero range $battle.heroes>>
    <<if $heroStates[_hero.id]>>
        <<set $heroStates[_hero.id].hp to _hero.hp>>
        <<set $heroStates[_hero.id].maxHp to _hero.maxHp>>
        <<set $heroStates[_hero.id].level to _hero.level>>
    <</if>>
<</for>>

<div class="victory-screen">
    <h1>ğŸ‰ æˆ˜æ–—èƒœåˆ©ï¼ğŸ‰</h1>
    
    <div class="battle-summary">
        <h3>æˆ˜æ–—æ€»ç»“</h3>
        
        <div class="heroes-final-state">
            <h4>é˜Ÿä¼çŠ¶æ€</h4>
            <<for _hero range $battle.heroes>>
                <div class="hero-final">
                    _hero.name: HP _hero.hp/_hero.maxHp
                </div>
            <</for>>
        </div>
        
        <div class="rewards">
            <h4>æˆ˜åˆ©å“</h4>
            <p>è·å¾—ç»éªŒå€¼: 50</p>
            <p>è·å¾—é‡‘å¸: 20</p>
        </div>
    </div>
    
    <<link "è¿”å›æ£®æ—" "æ£®æ—">><</link>>
</div>


:: æˆ˜æ–—å¤±è´¥ [nobr] {"position":"600,600"}
/* ä¿å­˜è‹±é›„å½“å‰è¡€é‡ */
<<if $battle and $battle.heroes>>
    <<for _hero range $battle.heroes>>
        <<if $heroStates[_hero.id]>>
            <<set $heroStates[_hero.id].hp to _hero.hp>>
            <<set $heroStates[_hero.id].maxHp to _hero.maxHp>>
            <<set $heroStates[_hero.id].level to _hero.level>>
        <</if>>
    <</for>>
<</if>>

<<set $states.energy.value -= 50>>

<div class="defeat-screen">
    <h1>ğŸ’€ æˆ˜æ–—å¤±è´¥ ğŸ’€</h1>
    
    <div class="defeat-message">
        <p>ä½ çš„é˜Ÿä¼å…¨å†›è¦†æ²¡...</p>
        <p class="energy-loss">ä½“åŠ› -50 (å½“å‰: $states.energy.value)</p>
    </div>
    
    <<if $states.energy.value <= 0>>
        <<set $states.energy.value to 0>>
        <div class="critical-message">
            <p>ä½ å·²ç»ç­‹ç–²åŠ›å°½ï¼Œå¿…é¡»è¿”å›åŸºåœ°ä¼‘æ¯ï¼</p>
        </div>
        <<link "è¿”å›åŸºåœ°" "ä¸»åŸºåœ°">><</link>>
    <<else>>
        <div class="continue-message">
            <p>ä½ è¿˜æœ‰ä½“åŠ›ç»§ç»­æ¢ç´¢...</p>
        </div>
        <<link "è¿”å›æ£®æ—" "æ£®æ—">><</link>>
    <</if>>
</div>


:: æ£®æ— [nobr] {"position":"800,800"}
<div class="forest-area">
    <h2>ç¥ç§˜æ£®æ—</h2>
    <p>ä½ åœ¨æ£®æ—ä¸­æ¢ç´¢...</p>
    <p>å½“å‰ä½“åŠ›: $states.energy.value/$states.energy.max</p>
    
    <<link "é­é‡å²è±å§†" "æˆ˜æ–—å¼€å§‹">>
        <<set $encounterMonsters to ["slime", "slime"]>>
    <</link>>
    
    <<link "è¿”å›åŸºåœ°" "ä¸»åŸºåœ°">><</link>>
</div>


:: BattleStylesheet [stylesheet]
/* æˆ˜æ–—é¡µé¢ç¾åŒ– */

/* æˆ˜æ–—ä¸»å®¹å™¨ - ä½¿ç”¨å¼¹æ€§å¸ƒå±€ */
.battle-container {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 15px;
    justify-content: flex-start;
    padding: 10px;
    background-color: rgba(20, 20, 20, 0.3);
    border-radius: 8px;
}

/* æ•Œäººå¡ç‰‡æ ·å¼ */
.enemy-card {
    flex: 1 0 calc(20% - 10px);
    min-width: 150px;
    border: 2px solid #d4af37;
    border-radius: 8px;
    padding: 12px;
    background: linear-gradient(135deg, rgba(80, 20, 20, 0.95), rgba(40, 20, 20, 0.95));
    box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3);
    color: white;
    font-weight: 500;
}

.enemy-card:hover {
    box-shadow: 0 6px 16px rgba(212, 175, 55, 0.5);
    transform: translateY(-2px);
    transition: all 0.3s ease;
}

/* ç©å®¶ä¿¡æ¯åŒºåŸŸæ ·å¼ */
.player-info {
    border: 2px solid #4CAF50;
    border-radius: 8px;
    padding: 12px;
    margin: 15px 0;
    background: linear-gradient(135deg, rgba(220, 255, 220, 0.95), rgba(200, 240, 200, 0.95));
    color: #1a1a1a;
    box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
}

.player-info div {
    padding: 5px 0;
    border-bottom: 1px solid rgba(76, 175, 80, 0.2);
}

.player-info div:last-child {
    border-bottom: none;
}

/* æ“ä½œåŒºåŸŸæ ·å¼ */
.action-section {
    border: 2px solid #2196F3;
    border-radius: 8px;
    padding: 15px;
    background: linear-gradient(135deg, rgba(230, 240, 255, 0.95), rgba(210, 230, 255, 0.95));
    color: #1a1a1a;
    margin: 15px 0;
    box-shadow: 0 2px 8px rgba(33, 150, 243, 0.3);
}

/* æ“ä½œç»„æ ·å¼ */
.action-group {
    margin-bottom: 15px;
    padding: 10px;
    background-color: rgba(255, 255, 255, 0.5);
    border-radius: 6px;
}

/* æ“ä½œæ ‡é¢˜æ ·å¼ */
.action-title {
    font-weight: bold;
    color: #1976D2;
    margin-bottom: 10px;
    font-size: 1.15em;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
}

/* æ“ä½œé“¾æ¥å®¹å™¨æ ·å¼ */
.action-links {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
}

.action-links label {
    padding: 6px 12px;
    background-color: rgba(255, 255, 255, 0.8);
    border: 1px solid #2196F3;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.action-links label:hover {
    background-color: rgba(33, 150, 243, 0.2);
    border-color: #1976D2;
}

/* æˆ˜æ–—æ—¥å¿—æ ·å¼ */
.battle-log {
    background: linear-gradient(135deg, rgba(255, 250, 240, 0.95), rgba(250, 245, 230, 0.95));
    border: 2px solid #FF9800;
    border-radius: 6px;
    padding: 12px;
    margin: 10px 0;
    max-height: 250px;
    overflow-y: auto;
    color: #2c2c2c;
    font-size: 0.95em;
    line-height: 1.6;
    box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
}

/* è¡ŒåŠ¨ç»“æœå®¹å™¨ */
.action-result {
    padding: 20px;
    background: linear-gradient(135deg, rgba(230, 245, 255, 0.98), rgba(210, 235, 255, 0.98));
    border-radius: 10px;
    margin: 15px 0;
    border: 2px solid #2196F3;
    box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
    color: #1a1a1a;
}

.action-result h3 {
    color: #0D47A1;
    margin-bottom: 15px;
    border-bottom: 2px solid #2196F3;
    padding-bottom: 8px;
    font-weight: bold;
}

.action-result p {
    color: #1a1a1a;
    font-weight: 500;
}

/* æ€ªç‰©å›åˆå®¹å™¨ - åŠ æ·±é¢œè‰²ï¼Œæ›´æ˜æ˜¾ */
.monster-turn {
    padding: 20px;
    background: linear-gradient(135deg, rgba(180, 50, 50, 0.95), rgba(140, 30, 30, 0.95));
    border-radius: 10px;
    margin: 15px 0;
    border: 3px solid #C62828;
    box-shadow: 0 4px 16px rgba(198, 40, 40, 0.5);
    color: white;
}

.monster-turn h3 {
    color: #FFE0E0;
    margin-bottom: 15px;
    border-bottom: 2px solid #FF5252;
    padding-bottom: 8px;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
}

.monster-turn .battle-log {
    background: linear-gradient(135deg, rgba(255, 230, 230, 0.95), rgba(255, 210, 210, 0.95));
    border-color: #EF5350;
    color: #2c2c2c;
}

/* éª°å­ç»“æœæ˜¾ç¤º */
.dice-results-summary {
    background: linear-gradient(135deg, rgba(255, 245, 220, 0.95), rgba(255, 235, 200, 0.95));
    border: 2px solid #FF9800;
    border-radius: 8px;
    padding: 15px;
    margin: 15px 0;
}

.dice-results-summary h4 {
    color: #E65100;
    margin-bottom: 10px;
    font-weight: bold;
}

.result-item {
    padding: 8px 12px;
    margin: 5px 0;
    background-color: rgba(255, 255, 255, 0.9);
    border-left: 4px solid #FF9800;
    border-radius: 4px;
    color: #1a1a1a;
    font-weight: 500;
}

/* ä½“åŠ›æ˜¾ç¤ºæ ·å¼ */
.energy-display {
    padding: 8px 12px;
    background: linear-gradient(135deg, rgba(120, 200, 255, 0.3), rgba(100, 180, 255, 0.3));
    border: 2px solid #4CAF50;
    border-radius: 6px;
    margin-bottom: 10px;
    font-weight: bold;
    font-size: 0.95em;
    color: #1a1a1a;
    box-shadow: 0 2px 6px rgba(76, 175, 80, 0.2);
}

/* å‡ºæ‹›é¡ºåºæ ·å¼ */
.turn-order {
    padding: 8px 12px;
    background: linear-gradient(135deg, rgba(255, 235, 200, 0.9), rgba(255, 220, 180, 0.9));
    border: 2px solid #FF9800;
    border-radius: 6px;
    margin-bottom: 15px;
    font-size: 0.9em;
    color: #1a1a1a;
    box-shadow: 0 2px 6px rgba(255, 152, 0, 0.2);
}

.turn-order strong {
    color: #E65100;
    margin-right: 8px;
}

.turn-unit {
    color: #424242;
    padding: 2px 6px;
    background-color: rgba(255, 255, 255, 0.5);
    border-radius: 3px;
    margin: 0 2px;
}

.current-turn-unit {
    color: #1B5E20;
    font-weight: bold;
    padding: 2px 8px;
    background-color: rgba(76, 175, 80, 0.3);
    border: 1px solid #4CAF50;
    border-radius: 4px;
    margin: 0 2px;
}

/* æˆ˜æ–—å¼€å§‹é¢„è§ˆ */
.battle-start-screen {
    padding: 25px;
    background: linear-gradient(135deg, rgba(240, 248, 255, 0.98), rgba(230, 240, 255, 0.98));
    border-radius: 12px;
    border: 3px solid #2196F3;
    box-shadow: 0 4px 16px rgba(33, 150, 243, 0.3);
}

.battle-start-screen h2 {
    color: #1976D2;
    text-align: center;
    margin-bottom: 20px;
    font-size: 1.8em;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.battle-preview {
    margin: 20px 0;
    padding: 20px;
    background-color: rgba(255, 255, 255, 0.9);
    border: 2px solid #1976D2;
    border-radius: 10px;
    box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
}

.battle-preview h3 {
    color: #1976D2;
    margin: 15px 0 10px 0;
    border-bottom: 2px solid #2196F3;
    padding-bottom: 5px;
}

.preview-hero, .preview-enemy {
    padding: 10px 15px;
    margin: 8px 0;
    border-left: 5px solid #4CAF50;
    background-color: rgba(255, 255, 255, 0.7);
    border-radius: 4px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    color: #1a1a1a;
    font-weight: 600;
    font-size: 1.05em;
}

.preview-enemy {
    border-left-color: #d4af37;
    background-color: rgba(255, 250, 240, 0.7);
    color: #2c2c2c;
}

/* èƒœåˆ©/å¤±è´¥ç•Œé¢ */
.victory-screen, .defeat-screen {
    padding: 30px;
    border-radius: 12px;
    text-align: center;
}

.victory-screen {
    background: linear-gradient(135deg, rgba(200, 255, 200, 0.98), rgba(180, 240, 180, 0.98));
    border: 3px solid #4CAF50;
    box-shadow: 0 4px 16px rgba(76, 175, 80, 0.4);
}

.victory-screen h1 {
    color: #2E7D32;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

.defeat-screen {
    background: linear-gradient(135deg, rgba(255, 200, 200, 0.98), rgba(240, 180, 180, 0.98));
    border: 3px solid #C62828;
    box-shadow: 0 4px 16px rgba(198, 40, 40, 0.4);
}

.defeat-screen h1 {
    color: #B71C1C;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

/* æ£®æ—ç•Œé¢ */
.forest-area {
    padding: 20px;
    background: linear-gradient(135deg, rgba(200, 230, 200, 0.95), rgba(180, 210, 180, 0.95));
    border-radius: 10px;
    border: 2px solid #4CAF50;
}
